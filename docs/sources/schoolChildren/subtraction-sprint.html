<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Subtraction Sprint</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0a1433;
      --card:#0f172aee;
      --border:#1f2a44;
      --text:#eaf0ff;
      --muted:#a8b1c7;
      --accent:#5eead4;
      --accent-2:#60a5fa;
      --success:#22c55e;
      --danger:#f43f5e;
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:14px;
      --btn-bg:#12223a;
      --btn-bg-press:#0d1a2e;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;color:var(--text);background:radial-gradient(1200px 800px at 20% -10%, #16244a 5%, transparent 40%), radial-gradient(1200px 800px at 120% 110%, #1a2b55 5%, transparent 40%), linear-gradient(160deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    body{overflow-x:hidden}
    .stars{pointer-events:none;position:fixed;inset:0;background:
      radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,.25) 40%, transparent 45%),
      radial-gradient(2px 2px at 70% 20%, rgba(255,255,255,.2) 40%, transparent 45%),
      radial-gradient(2px 2px at 40% 70%, rgba(255,255,255,.18) 40%, transparent 45%),
      radial-gradient(2px 2px at 80% 80%, rgba(255,255,255,.22) 40%, transparent 45%);
      animation: twinkle 5s ease-in-out infinite alternate;
      opacity:.5
    }
    @keyframes twinkle{to{opacity:.9; transform:translateY(-2px)}}
    .wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:18px;gap:16px}
    .topbar{width:min(720px,96vw);display:flex;align-items:center;justify-content:space-between;padding:10px 12px;margin-top:8px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:14px;backdrop-filter:blur(6px)}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 200deg, var(--accent), var(--accent-2), #a78bfa, var(--accent));box-shadow:0 0 18px rgba(94,234,212,.35)}
    .title{font-weight:800;letter-spacing:.3px}
    .stats{display:flex;align-items:center;gap:12px;color:var(--muted);font-weight:700}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0f1a33;border:1px solid #23325a;color:#cbd5ff;padding:6px 10px;border-radius:999px;font-size:13px}
    .controls{display:flex;align-items:center;gap:8px}
    .tbtn{appearance:none;outline:none;border:1px solid #253456;background:#0f1a33;color:#dbe7ff;border-radius:999px;padding:6px 10px;font-weight:700;font-size:13px;cursor:pointer;transition:transform .06s ease, background .2s ease, border-color .2s ease}
    .tbtn:active{transform:scale(.98)}
    .tbtn[data-off="true"]{opacity:.75;background:#0c1429;border-color:#1e2b49}
    .card{width:min(720px,96vw);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:14px;backdrop-filter:blur(6px)}
    .big{font-size: clamp(28px, 6vw, 56px);font-weight:900;letter-spacing:.8px;text-align:center;line-height:1.15}
    .big .op{color:var(--accent-2);text-shadow:0 0 10px rgba(96,165,250,.25)}
    .sub{color:var(--muted);text-align:center;margin-top:-6px}
    .opts{display:grid;grid-template-columns:repeat(auto-fit, minmax(120px,1fr));gap:12px;margin-top:6px}
    .btn{position:relative;isolation:isolate;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#132644,#0f1f39);color:#ffffff;border:1px solid #1f3256;border-radius:14px;padding:16px 14px;font-weight:800;font-size:clamp(18px,4.5vw,22px);cursor:pointer;transition:transform .08s ease, box-shadow .2s ease, background .2s ease; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .btn::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(80% 60% at 50% 0%, rgba(255,255,255,.08), transparent 60%);pointer-events:none}
    .btn:hover{box-shadow:0 10px 26px rgba(0,0,0,.35)}
    .btn:active{transform:translateY(1px) scale(.99);background:linear-gradient(180deg,#10213b,#0c192e)}
    .btn.correct{border-color:rgba(34,197,94,.8);box-shadow:0 6px 22px rgba(34,197,94,.35)}
    .btn.wrong{border-color:rgba(244,63,94,.7);box-shadow:0 6px 22px rgba(244,63,94,.25)}
    .shake{animation:shake .35s ease}
    @keyframes shake{
      10%,90%{transform:translateX(-2px)}
      20%,80%{transform:translateX(3px)}
      30%,50%,70%{transform:translateX(-5px)}
      40%,60%{transform:translateX(5px)}
    }
    .fadeUp{animation:fadeUp .5s ease-out both}
    @keyframes fadeUp{
      from{opacity:0; transform:translateY(10px)}
      to{opacity:1; transform:translateY(0)}
    }
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:10}
    .overlay .bubble{display:flex;align-items:center;justify-content:center;width:160px;height:160px;border-radius:999px;background:radial-gradient(60% 60% at 50% 40%, rgba(255,255,255,.2), rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(4px);box-shadow:0 10px 40px rgba(0,0,0,.45)}
    .overlay .num{font-size:88px;font-weight:900;text-shadow:0 6px 22px rgba(0,0,0,.6);animation:pop .6s cubic-bezier(.2,1.1,.2,1) infinite}
    @keyframes pop{0%{transform:scale(.9);opacity:.9} 50%{transform:scale(1);opacity:1} 100%{transform:scale(.9);opacity:.95}}
    .confetti{pointer-events:none;position:fixed;inset:0;overflow:hidden;z-index:20}
    .piece{position:absolute;width:10px;height:14px;opacity:0.9;will-change:transform}
    .sr{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
    .footer{color:#9fb0d9a1;text-align:center;font-size:12px}
    @media (prefers-reduced-motion: reduce){
      .fadeUp,.shake,.overlay .num{animation:none}
      .stars{animation:none}
    }
    /* Touch polish */
    button, .tbtn, .btn{-webkit-tap-highlight-color:transparent; touch-action:manipulation}
    .noselect{user-select:none; -webkit-user-select:none}
  </style>
</head>
<body>
  <div class="stars" aria-hidden="true"></div>
  <div class="wrap noselect">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">Subtraction Sprint</div>
      </div>
      <div class="stats">
        <span class="badge" id="scoreBadge">Score: <strong id="score">0</strong></span>
        <span class="badge" id="streakBadge">Streak: <strong id="streak">0</strong></span>
      </div>
      <div class="controls">
        <button class="tbtn" id="soundBtn" aria-pressed="false" title="Toggle sound">ðŸ”Š Sound</button>
        <button class="tbtn" id="voiceBtn" aria-pressed="true" title="Toggle voice">ðŸ—£ Voice</button>
      </div>
    </div>

    <div class="card">
      <div class="big" id="expr"><span class="numA">6</span> <span class="op">âˆ’</span> <span class="numB">2</span> = ?</div>
      <div class="sub" id="hint">Choose the correct answer</div>
      <div class="opts" id="opts"></div>
    </div>

    <div class="footer">Tip: Tap an answer or use 1â€“4 keys. Toggle sound/voice in the top right.</div>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="bubble">
      <div class="num" id="num">3</div>
    </div>
  </div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <div class="sr" aria-live="polite" id="live"></div>

  <script>
    "use strict";

    // Utility
    const $ = sel => document.querySelector(sel);
    const exprEl = $('#expr');
    const optsEl = $('#opts');
    const overlay = $('#overlay');
    const numEl = $('#num');
    const hintEl = $('#hint');
    const confettiEl = $('#confetti');
    const scoreEl = $('#score');
    const streakEl = $('#streak');
    const soundBtn = $('#soundBtn');
    const voiceBtn = $('#voiceBtn');
    const live = $('#live');

    let a=0,b=0,ans=0, locked=false;
    let score=0, streak=0;
    let allowSound = JSON.parse(localStorage.getItem('soundOn') ?? 'true');
    let allowVoice = JSON.parse(localStorage.getItem('voiceOn') ?? 'true');

    // Accessibility toggles UI
    function updateTogglesUI(){
      soundBtn.dataset.off = String(!allowSound);
      soundBtn.setAttribute('aria-pressed', String(allowSound));
      soundBtn.textContent = (allowSound? 'ðŸ”Š':'ðŸ”‡') + ' Sound';
      voiceBtn.dataset.off = String(!allowVoice);
      voiceBtn.setAttribute('aria-pressed', String(allowVoice));
      voiceBtn.textContent = (allowVoice? 'ðŸ—£':'ðŸ¤«') + ' Voice';
    }
    soundBtn.addEventListener('click', () => {
      allowSound = !allowSound;
      localStorage.setItem('soundOn', JSON.stringify(allowSound));
      updateTogglesUI();
      if(allowSound) SFX.pop();
    });
    voiceBtn.addEventListener('click', () => {
      allowVoice = !allowVoice;
      localStorage.setItem('voiceOn', JSON.stringify(allowVoice));
      updateTogglesUI();
      if(allowSound) SFX.pop();
    });
    updateTogglesUI();

    // Haptics
    function vibe(ms){ try{ if('vibrate' in navigator) navigator.vibrate(ms);}catch(_){} }

    // Speech (optional)
    function speak(text){
      try{
        if(!allowVoice || !('speechSynthesis' in window)) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(String(text));
        u.lang = 'en-US';
        u.rate = 1;
        speechSynthesis.speak(u);
      }catch(_){}
    }

    // WebAudio SFX
    const SFX = (() => {
      let ctx;
      function ensure(){
        if(!allowSound) return null;
        if(!ctx){
          try{ ctx = new (window.AudioContext || window.webkitAudioContext)(); }
          catch(_){ ctx = null; }
        }
        if(ctx && ctx.state === 'suspended'){ ctx.resume(); }
        return ctx;
      }
      function beep({freq=440, dur=0.12, type='sine', vol=0.2, attack=0.005, decay=0.08}={}){
        const ac = ensure(); if(!ac) return;
        const t0 = ac.currentTime + 0.01;
        const o = ac.createOscillator();
        const g = ac.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, t0);
        g.gain.setValueAtTime(0, t0);
        g.gain.linearRampToValueAtTime(vol, t0 + attack);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur + decay);
        o.connect(g); g.connect(ac.destination);
        o.start(t0); o.stop(t0 + dur + decay + 0.02);
      }
      return {
        correct(){
          beep({freq:620, dur:.07, type:'triangle', vol:.22});
          setTimeout(()=>beep({freq:760, dur:.08, type:'triangle', vol:.22}), 70);
          setTimeout(()=>beep({freq:920, dur:.10, type:'triangle', vol:.22}), 150);
        },
        wrong(){
          beep({freq:200, dur:.14, type:'sawtooth', vol:.18});
          setTimeout(()=>beep({freq:150, dur:.16, type:'sawtooth', vol:.18}), 120);
        },
        tick(){ beep({freq:1100, dur:.05, type:'square', vol:.16}); },
        pop(){ beep({freq:480, dur:.06, type:'square', vol:.16}); }
      };
    })();

    // Confetti
    function launchConfetti(count=28){
      const colors = ['#60a5fa','#5eead4','#a78bfa','#f472b6','#fbbf24','#34d399'];
      const w = window.innerWidth, h = window.innerHeight;
      for(let i=0;i<count;i++){
        const piece = document.createElement('div');
        piece.className='piece';
        const c = colors[(Math.random()*colors.length)|0];
        const x = Math.random()*w*0.9 + w*0.05;
        const rot = Math.random()*360;
        piece.style.left = x + 'px';
        piece.style.top = '-20px';
        piece.style.background = c;
        piece.style.transform = `rotate(${rot}deg)`;
        confettiEl.appendChild(piece);
        const fall = 800 + Math.random()*800;
        const drift = (Math.random()*60 - 30);
        const scale = 0.7 + Math.random()*0.8;
        piece.animate([
          { transform:`translate3d(0,0,0) rotate(${rot}deg) scale(${scale})`, opacity:1 },
          { transform:`translate3d(${drift}px, ${h+40}px, 0) rotate(${rot+360}deg) scale(${scale})`, opacity:0.9 }
        ], { duration: fall, easing:'cubic-bezier(.2,.7,.2,1)' });
        setTimeout(()=> piece.remove(), fall+50);
      }
    }

    function randint(n,m){ return Math.floor(Math.random()*(m-n+1))+n; }

    function newExpr(){
      locked = false;
      a = randint(3, 12);
      b = randint(1, a-1);
      ans = a - b;
      exprEl.innerHTML = `<span class="numA">${a}</span> <span class="op">âˆ’</span> <span class="numB">${b}</span> = ?`;
      hintEl.textContent = 'Choose the correct answer';
      live.textContent = `What is ${a} minus ${b}?`;
      if(allowVoice) speak(`${a} minus ${b}`);
      renderOptions(answerOptions(ans));
      SFX.pop();
    }

    function answerOptions(correct){
      const set = new Set([correct]);
      const options = [correct];
      while(options.length < 4){
        const delta = randint(-4, 6);
        let v = correct + delta;
        if(v < 0) v = Math.abs(delta);
        if(!set.has(v)){
          set.add(v);
          options.push(v);
        }
      }
      return options.sort(()=>Math.random()-0.5);
    }

    function renderOptions(values){
      optsEl.innerHTML = '';
      values.forEach((v, i)=>{
        const btn = document.createElement('button');
        btn.className = 'btn fadeUp';
        btn.style.animationDelay = `${i*60}ms`;
        btn.textContent = v;
        btn.setAttribute('data-val', v);
        btn.addEventListener('click', ()=> pick(v, btn), {passive:true});
        btn.addEventListener('pointerdown', ()=> btn.style.transform='scale(.99)');
        btn.addEventListener('pointerup', ()=> btn.style.transform='');
        optsEl.appendChild(btn);
      });
    }

    function pick(v, btn){
      if(locked) return;
      if(v === ans){
        locked = true;
        btn.classList.add('correct');
        score += 10 + Math.min(20, streak*2);
        streak += 1;
        updateHUD();
        hintEl.innerHTML = `Correct! <span style="color:${getComputedStyle(document.documentElement).getPropertyValue('--success')}">+${10 + Math.min(20, (streak-1)*2)}</span>`;
        live.textContent = 'Correct';
        vibe(30);
        SFX.correct();
        launchConfetti(24 + Math.min(20, streak*2));
        countdown(()=> newExpr());
      }else{
        btn.classList.add('wrong','shake');
        setTimeout(()=> btn.classList.remove('shake'), 400);
        streak = 0;
        updateHUD();
        hintEl.textContent = 'Try again!';
        live.textContent = 'Try again';
        vibe([20,30,20]);
        SFX.wrong();
      }
    }

    function updateHUD(){
      scoreEl.textContent = String(score);
      streakEl.textContent = String(streak);
    }

    function countdown(cb){
      overlay.style.display = 'flex';
      let k = 3;
      numEl.textContent = k;
      const step = () => {
        SFX.tick();
        k--;
        if(k<=0){
          overlay.style.display='none';
          cb();
        }else{
          numEl.textContent = k;
          setTimeout(step, 560);
        }
      };
      setTimeout(step, 560);
    }

    // Keyboard shortcuts (optional)
    window.addEventListener('keydown', (e)=>{
      if(locked) return;
      const idx = ({'1':0,'2':1,'3':2,'4':3})[e.key];
      if(idx != null){
        const btn = optsEl.children[idx];
        if(btn) btn.click();
      }
      if(e.key === 'r'){
        speak(`${a} minus ${b}`);
      }
    });

    // Start
    newExpr();
  </script>
</body>
</html>