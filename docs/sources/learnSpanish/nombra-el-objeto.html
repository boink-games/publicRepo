<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<title>¬øQu√© es esto? - Juego en Espa√±ol</title>
<style>
  :root{
    --bg-from:#f9f3ff;
    --bg-to:#e6f8ff;
    --card:#ffffffee;
    --accent:#6c5ce7;
    --accent-2:#00b894;
    --accent-3:#fdcb6e;
    --text:#2d3436;
    --muted:#636e72;
    --shadow:0 10px 25px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.06);
    --radius:20px;
  }
  html,body{
    height:100%;
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    color:var(--text);
    background: linear-gradient(160deg, var(--bg-from), var(--bg-to));
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{
    min-height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: clamp(10px,2.5vw,24px);
  }
  .game{
    width:min(960px, 98vw);
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: clamp(12px,2.4vw,28px);
    position:relative;
    overflow:hidden;
  }
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom: clamp(10px,2vw,20px);
  }
  .title{
    font-size: clamp(20px, 3.5vw, 36px);
    font-weight:800;
    letter-spacing:.3px;
    color:#2d3436;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .title .spark{font-size: 1.1em}
  .score{
    background:#fff;
    border-radius: 999px;
    padding:8px 14px;
    box-shadow: var(--shadow);
    font-weight:700;
    font-size: clamp(14px, 2.4vw, 18px);
    color:#2d3436;
  }

  .stage{
    display:grid;
    grid-template-columns: 1fr;
    gap: clamp(12px,2.2vw,22px);
  }

  .mainCard{
    display:flex;
    align-items:center;
    justify-content:center;
    background: radial-gradient(circle at 30% 30%, #ffffff, #f4f7ff);
    border-radius: calc(var(--radius) + 10px);
    padding: clamp(16px,3vw,28px);
    box-shadow: inset 0 2px 10px rgba(0,0,0,.04), var(--shadow);
    min-height: clamp(180px, 30vw, 320px);
    position:relative;
    overflow:hidden;
  }
  .mainBadge{
    width: clamp(140px, 26vw, 260px);
    height: clamp(140px, 26vw, 260px);
    border-radius: 50%;
    display:grid;
    place-items:center;
    background: conic-gradient(from 200deg, #ffeaa7, #a29bfe, #81ecec, #ff7675, #55efc4, #ffeaa7);
    filter: drop-shadow(0 8px 14px rgba(0,0,0,.12));
    position:relative;
  }
  .mainBadge::after{
    content:"";
    position:absolute;
    inset:6px;
    border-radius:50%;
    background:#fff;
  }
  #mainEmoji{
    position:relative;
    z-index:1;
    font-size: clamp(90px, 16vw, 180px);
    line-height:1;
    transform: translateZ(0);
    user-select:none;
  }

  .controls{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .btn{
    -webkit-appearance:none;
    appearance:none;
    border:none;
    outline:none;
    background: var(--accent);
    color:#fff;
    padding: 12px 18px;
    border-radius: 14px;
    font-weight:800;
    letter-spacing:.3px;
    box-shadow: 0 8px 18px rgba(108,92,231,.35), inset 0 -2px 0 rgba(0,0,0,.1);
    cursor:pointer;
    transition: transform .08s ease, filter .2s ease, background .2s ease;
    font-size: clamp(14px,2.4vw,18px);
  }
  .btn:active{ transform: translateY(1px) scale(.98) }
  .btn.secondary{
    background:#fff;
    color:var(--accent);
    border:2px solid var(--accent);
    box-shadow: var(--shadow);
  }
  .btn.round{
    border-radius: 999px;
    padding: 12px 16px;
    display:flex; align-items:center; gap:8px;
  }

  .choices{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: clamp(10px,2vw,20px);
  }
  .choice{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    border-radius: 18px;
    min-height: clamp(90px, 14vw, 140px);
    box-shadow: var(--shadow);
    cursor:pointer;
    border:3px solid transparent;
    transition: transform .08s ease, border-color .2s, box-shadow .2s, background .2s;
    user-select:none;
    touch-action: manipulation;
  }
  .choice:active{ transform: scale(.98) }
  .choice .emoji{
    font-size: clamp(56px, 10vw, 100px);
    line-height:1;
    transform: translateZ(0);
    pointer-events:none;
  }
  .choice .key{
    position:absolute;
    top:8px; left:8px;
    background: #0000000d;
    color:#444;
    font-weight:800;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
  }
  .choice.correct{
    border-color: var(--accent-2);
    box-shadow: 0 8px 18px rgba(0,184,148,.28), inset 0 -2px 0 rgba(0,0,0,.06);
    animation: pop .26s ease;
  }
  .choice.wrong{
    border-color: #ff7675;
    animation: shake .28s ease;
  }
  @keyframes pop {
    0%{ transform: scale(1) }
    50%{ transform: scale(1.04) }
    100%{ transform: scale(1) }
  }
  @keyframes shake{
    0%{ transform: translateX(0) }
    25%{ transform: translateX(-6px) }
    50%{ transform: translateX(6px) }
    75%{ transform: translateX(-4px) }
    100%{ transform: translateX(0) }
  }

  .instructions{
    text-align:center;
    color:var(--muted);
    font-size: clamp(14px,2.2vw,18px);
    margin-top: 2px;
  }

  .overlay{
    position:absolute;
    inset:0;
    display:grid;
    place-items:center;
    background: linear-gradient(160deg, rgba(249,243,255,.98), rgba(230,248,255,.98));
    z-index: 10;
    padding: 24px;
  }
  .panel{
    width:min(720px, 96vw);
    background:#fff;
    border-radius: 20px;
    box-shadow: var(--shadow);
    padding: clamp(18px,3vw,32px);
    text-align:center;
  }
  .panel h1{
    margin:0 0 6px 0;
    font-size: clamp(24px, 5vw, 40px);
  }
  .panel p{
    margin:6px 0;
    color:#636e72;
    font-size: clamp(15px, 2.5vw, 18px);
  }
  .tips{
    display:grid;
    gap:8px;
    text-align:left;
    margin: 14px auto 18px;
    max-width: 680px;
  }
  .badgeRow{
    display:flex; justify-content:center; gap:10px; margin:12px 0 18px;
  }
  .mini{
    background:#fff;
    border:2px solid #eee;
    border-radius:12px;
    padding:10px 12px;
    box-shadow: var(--shadow);
    display:flex; align-items:center; gap:8px;
    font-weight:700;
    color:#333;
  }

  .confetti{
    position:absolute;
    inset:0;
    pointer-events:none;
    overflow:hidden;
  }
  .confetti .bit{
    position:absolute;
    width:10px; height:14px;
    will-change: transform, opacity;
  }

  /* Focus & accessibility */
  .btn:focus-visible, .choice:focus-visible{
    outline: 3px solid #74b9ff;
    outline-offset: 2px;
  }

  @media (max-width:520px){
    .score{ padding:6px 12px }
    .choice .key{ display:none }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="game" role="application" aria-label="Juego: ¬øQu√© es esto?">
    <div class="topbar">
      <div class="title"><span class="spark">üåà</span> ¬øQu√© es esto?</div>
      <div class="score" aria-live="polite">Puntos: <span id="score">0</span> ‚≠ê</div>
    </div>

    <div class="stage">
      <div class="mainCard" aria-live="polite">
        <div class="mainBadge" aria-hidden="true"></div>
        <div id="mainEmoji" role="img" aria-label="Objeto a adivinar">‚ùì</div>
      </div>

      <div class="controls">
        <button id="repeatBtn" class="btn round secondary" aria-label="Repetir la pregunta"><span aria-hidden="true">üîä</span> Repetir</button>
      </div>

      <div id="choices" class="choices" role="listbox" aria-label="Opciones"></div>

      <div class="instructions">
        Toca o haz clic en la imagen correcta. Tambi√©n puedes usar las teclas 1, 2 o 3. Pulsa Espacio para escuchar de nuevo.
      </div>
    </div>

    <div id="confetti" class="confetti" aria-hidden="true"></div>

    <div id="startOverlay" class="overlay">
      <div class="panel">
        <h1>¬°Vamos a jugar!</h1>
        <p>Escucha: una voz dice ‚Äú¬øQu√© es esto?‚Äù y el nombre del objeto.</p>
        <p>Luego toca o haz clic en la imagen que coincide.</p>
        <div class="badgeRow">
          <div class="mini">üñ±Ô∏è Clic</div>
          <div class="mini">üëÜ Toque</div>
          <div class="mini">‚å®Ô∏è 1 ¬∑ 2 ¬∑ 3</div>
          <div class="mini">üîä Espacio = Repetir</div>
        </div>
        <button id="startBtn" class="btn round" style="font-size: clamp(16px,3vw,22px); padding: 14px 22px;"><span aria-hidden="true">‚ñ∂Ô∏è</span> Empezar</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const items = [
    {name:'pelota', article:'una', emoji:'üèÄ'},
    {name:'coche', article:'un', emoji:'üöó'},
    {name:'casa', article:'una', emoji:'üè†'},
    {name:'perro', article:'un', emoji:'üê∂'},
    {name:'gato', article:'un', emoji:'üê±'},
    {name:'manzana', article:'una', emoji:'üçé'},
    {name:'libro', article:'un', emoji:'üìò'},
    {name:'estrella', article:'una', emoji:'‚≠êÔ∏è'},
    {name:'flor', article:'una', emoji:'üå∏'},
    {name:'avi√≥n', article:'un', emoji:'üõ©Ô∏è'},
    {name:'tren', article:'un', emoji:'üöÇ'},
    {name:'sol', article:'un', emoji:'üåû'},
    {name:'luna', article:'una', emoji:'üåô'},
    {name:'√°rbol', article:'un', emoji:'üå≥'},
    {name:'barco', article:'un', emoji:'‚õµÔ∏è'},
    {name:'coraz√≥n', article:'un', emoji:'‚ù§Ô∏è'}
  ];

  const mainEmoji = document.getElementById('mainEmoji');
  const choicesEl = document.getElementById('choices');
  const scoreEl = document.getElementById('score');
  const repeatBtn = document.getElementById('repeatBtn');
  const startBtn = document.getElementById('startBtn');
  const startOverlay = document.getElementById('startOverlay');
  const confetti = document.getElementById('confetti');

  let current = null;
  let score = 0;
  let canAnswer = false;
  let lastTargetName = null;

  // Audio
  let audioCtx = null;

  function ensureAudio(){
    if(!audioCtx){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }catch(e){ /* ignore */ }
    }
    if(audioCtx && audioCtx.state === 'suspended'){
      audioCtx.resume();
    }
  }

  function playTone(frequency, time, duration, type='sine', gain=0.08){
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(frequency, time);
    g.gain.setValueAtTime(0, time);
    g.gain.linearRampToValueAtTime(gain, time + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, time + duration);
    osc.connect(g).connect(audioCtx.destination);
    osc.start(time);
    osc.stop(time + duration + 0.02);
  }

  function successSound(){
    ensureAudio();
    if(!audioCtx) return;
    const now = audioCtx.currentTime + 0.02;
    playTone(880, now, 0.12, 'triangle', 0.09);   // A5
    playTone(1108.73, now+0.09, 0.12, 'triangle', 0.09); // C#6
    playTone(1318.51, now+0.18, 0.16, 'triangle', 0.09); // E6
  }

  function gentleBuzz(){
    ensureAudio();
    if(!audioCtx) return;
    const now = audioCtx.currentTime + 0.01;
    playTone(140, now, 0.12, 'sawtooth', 0.04);
    playTone(120, now+0.02, 0.10, 'sawtooth', 0.04);
  }

  // Speech
  let spanishVoice = null;
  function chooseSpanishVoice(){
    const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
    const preferred = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('es-') && /Google|Microsoft|Samantha|Paulina|Monica|Camila|Luciana|Spanish|espa√±ol/i.test(v.name));
    const anyEs = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('es-'));
    spanishVoice = preferred || anyEs || null;
  }
  if('speechSynthesis' in window){
    chooseSpanishVoice();
    window.speechSynthesis.onvoiceschanged = chooseSpanishVoice;
  }

  function speak(text, {rate=0.9, pitch=1.05, volume=1} = {}){
    if(!('speechSynthesis' in window)) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      if(spanishVoice) u.voice = spanishVoice;
      u.lang = (spanishVoice && spanishVoice.lang) || 'es-ES';
      u.rate = rate;
      u.pitch = pitch;
      u.volume = volume;
      speechSynthesis.cancel(); // prevent overlaps on rapid taps
      speechSynthesis.speak(u);
      return u;
    }catch(e){}
  }

  function speakQuestionAndName(){
    if(!current) return;
    const q = '¬øQu√© es esto?';
    const name = `${current.article} ${current.name}`;
    // Queue with slight gap using onend for natural pacing
    if(!('speechSynthesis' in window)){ return; }
    const uq = new SpeechSynthesisUtterance(q);
    if(spanishVoice) uq.voice = spanishVoice;
    uq.lang = (spanishVoice && spanishVoice.lang) || 'es-ES';
    uq.rate = 0.9; uq.pitch = 1.05;
    uq.onend = () => {
      const u2 = new SpeechSynthesisUtterance(name);
      if(spanishVoice) u2.voice = spanishVoice;
      u2.lang = uq.lang;
      u2.rate = 0.92; u2.pitch = 1.1;
      window.speechSynthesis.speak(u2);
    };
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(uq);
  }

  // Utils
  function randInt(n){ return Math.floor(Math.random()*n); }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function sampleUnique(arr, count, avoid){
    const pool = arr.filter(x => !avoid || x.name !== avoid.name);
    const res = [];
    while(res.length < Math.min(count, pool.length)){
      const pick = pool.splice(randInt(pool.length),1)[0];
      res.push(pick);
    }
    return res;
  }

  function makeConfettiBurst(xRatio=0.5, yRatio=0.3){
    const colors = ['#ff7675','#74b9ff','#55efc4','#ffeaa7','#a29bfe','#fd79a8','#fab1a0','#81ecec'];
    const n = 42;
    const w = confetti.clientWidth || 600;
    const h = confetti.clientHeight || 400;
    const x0 = w * xRatio;
    const y0 = h * yRatio;

    for(let i=0;i<n;i++){
      const bit = document.createElement('div');
      bit.className = 'bit';
      const c = colors[i % colors.length];
      bit.style.background = c;
      bit.style.left = (x0) + 'px';
      bit.style.top = (y0) + 'px';
      bit.style.transform = 'translate(-50%,-50%)';
      const dx = (Math.random()*2 - 1) * (w*0.5);
      const dy = (Math.random()*0.6 + 0.2) * (h*0.8);
      const rot = Math.random()*720;
      const scale = 0.8 + Math.random()*0.6;
      const duration = 700 + Math.random()*600;
      const bez = 'cubic-bezier(.2,.6,.2,1)';
      bit.animate([
        { transform:`translate(-50%,-50%) rotate(0deg) scale(${scale})`, opacity:1 },
        { transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg) scale(${scale})`, opacity:0.1 }
      ], { duration, easing: bez, fill:'forwards' });
      confetti.appendChild(bit);
      setTimeout(()=>{ bit.remove(); }, duration+30);
    }
  }

  function renderChoices(options){
    choicesEl.innerHTML = '';
    options.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.setAttribute('role','option');
      btn.setAttribute('aria-label', `${opt.article} ${opt.name}`);
      btn.dataset.name = opt.name;
      btn.dataset.article = opt.article;

      const key = document.createElement('div');
      key.className = 'key';
      key.textContent = (idx+1).toString();
      key.setAttribute('aria-hidden','true');

      const em = document.createElement('div');
      em.className = 'emoji';
      em.textContent = opt.emoji;

      btn.appendChild(key);
      btn.appendChild(em);
      btn.addEventListener('click', () => choose(opt, btn));
      choicesEl.appendChild(btn);
    });
  }

  function nextRound(){
    canAnswer = false;
    // pick target different from last
    let target = items[randInt(items.length)];
    if(lastTargetName && items.length > 1){
      let tries = 0;
      while(target.name === lastTargetName && tries < 10){
        target = items[randInt(items.length)];
        tries++;
      }
    }
    current = target;
    lastTargetName = target.name;

    mainEmoji.textContent = target.emoji;
    mainEmoji.setAttribute('aria-label', `Adivina: ${target.article} ${target.name}`);

    // pick options
    const distractors = sampleUnique(items.filter(x=>x.name!==target.name), 2);
    const options = shuffle([target, ...distractors]);
    renderChoices(options);

    setTimeout(()=>{
      canAnswer = true;
      speakQuestionAndName();
    }, 200);
  }

  function choose(opt, btn){
    if(!canAnswer) return;
    if(!current) return;
    if(opt.name === current.name){
      canAnswer = false;
      btn.classList.add('correct');
      score++;
      scoreEl.textContent = score;
      navigator.vibrate && navigator.vibrate([60, 40, 60]);
      successSound();
      makeConfettiBurst(0.5, 0.25);

      // Praise and name
      if('speechSynthesis' in window){
        const u1 = new SpeechSynthesisUtterance('¬°Muy bien!');
        if(spanishVoice) u1.voice = spanishVoice;
        u1.lang = (spanishVoice && spanishVoice.lang) || 'es-ES';
        u1.rate = 1; u1.pitch = 1.1;
        const u2 = new SpeechSynthesisUtterance(`Es ${opt.article} ${opt.name}.`);
        if(spanishVoice) u2.voice = spanishVoice;
        u2.lang = u1.lang;
        u2.rate = 0.98; u2.pitch = 1.05;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u1);
        u1.onend = ()=> window.speechSynthesis.speak(u2);
      }

      setTimeout(()=> nextRound(), 1100);
    }else{
      btn.classList.add('wrong');
      setTimeout(()=> btn.classList.remove('wrong'), 260);
      navigator.vibrate && navigator.vibrate(40);
      gentleBuzz();
    }
  }

  function repeat(){
    ensureAudio();
    speakQuestionAndName();
  }

  // Keyboard controls
  document.addEventListener('keydown', (e)=>{
    if(e.repeat) return;
    const key = e.key;
    if(startOverlay && !startOverlay.hidden){
      if(key === 'Enter' || key === ' '){
        e.preventDefault();
        startBtn.click();
        return;
      }
    }
    if(key === ' '){
      e.preventDefault();
      repeat();
      return;
    }
    if(['1','2','3'].includes(key)){
      const idx = parseInt(key,10)-1;
      const btn = choicesEl.querySelectorAll('.choice')[idx];
      if(btn){ btn.click(); }
    }
  }, {passive:false});

  // Buttons
  repeatBtn.addEventListener('click', repeat);
  startBtn.addEventListener('click', ()=>{
    ensureAudio();
    startOverlay.style.display = 'none';
    nextRound();
  });

  // Make sure overlay hidden attribute aligns with style
  startOverlay.hidden = false;
})();
</script>
</body>
</html>