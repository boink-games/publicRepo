<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>√Årbol de Familia - Aprende Espa√±ol</title>
<style>
  :root{
    --bg1:#f3f7ff;
    --bg2:#eaf2ff;
    --ink:#1f2d3d;
    --muted:#6b7a90;
    --accent:#4c7dff;
    --accent2:#ff6aa7;
    --accent3:#29c491;
    --good:#2cb67d;
    --bad:#ef4444;
    --card:#ffffffcc;
    --ring:#bcd0ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background: radial-gradient(1200px 600px at 20% 0%,var(--bg2),transparent),
                radial-gradient(1200px 600px at 80% 100%,#fef6ff,transparent),
                linear-gradient(180deg,#f7fbff, #f5faff);
  }
  .wrap{
    max-width: 1000px;
    margin: min(4vh,32px) auto;
    padding: clamp(10px,2vw,24px);
  }
  .card{
    background: linear-gradient(170deg, #f9fcff, #f8f6ff);
    border-radius: 16px;
    box-shadow: 0 12px 50px -10px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.6);
    overflow: hidden;
  }
  header{
    display:flex;
    flex-direction: column;
    align-items: stretch;
    gap:12px;
    padding: 14px 16px;
    border-bottom:1px solid rgba(0,0,0,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.8), rgba(255,255,255,.5));
  }
  .title{
    display:flex;align-items:center;gap:12px;min-width:0;
    justify-content: center;
  }
  .title h1{font-size:clamp(28px, 4vw, 36px);margin:0;white-space:nowrap;color:var(--accent)}
  .subtitle{font-size:clamp(12px,1.4vw,14px);color:var(--muted)}
  .controls{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .select-wrapper {
    position: relative;
    display: inline-block;
  }
  .select-wrapper::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7a90'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    pointer-events: none;
  }
  .controls select {
    padding-right: 36px; /* Space for custom arrow */
  }
  button, select{
    appearance:none;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    color:var(--ink);
    padding:10px 12px;
    border-radius:10px;
    font-weight:600;
    letter-spacing:.2px;
    font-size:14px;
    box-shadow: 0 1px 0 rgba(255,255,255,.9) inset, 0 2px 6px rgba(0,0,0,.06);
    transition:.15s transform ease, .15s background ease, .15s box-shadow ease;
  }
  button:hover, select:hover{transform:translateY(-1px)}
  button:active{transform:translateY(0)}
  .accent{background:var(--accent); color:#fff; border-color:transparent}
  .ghost{background: #f7f9ff; border-color:#e4eaff}
  .muted{background:#f2f4f8; color:#42506a}
  .pill{border-radius:999px}
  .score{
    padding:6px 10px; border-radius:999px;
    background: #eef7ff; color:#1b4b9c; font-weight:800;
  }
  .bar{
    padding: 10px 16px;
    display:flex;
    gap:10px; align-items:center; justify-content:space-between;
    border-bottom:1px dashed rgba(0,0,0,.06);
  }
  .instructions{
    padding: 10px 16px 14px;
    color:var(--muted);
    font-size:14px;
    display:grid;
    gap:8px;
  }
  .instructions b{color:#234}
  .board{
    position:relative;
    width:100%;
    aspect-ratio: 1000 / 700;
    background: linear-gradient(180deg, #f8fbff, #f0f6ff);
  }
  svg{width:100%;height:100%;display:block}
  .node{cursor:pointer; outline:none;}
  .node .ring{
    fill: none; stroke-width: 12; stroke-linecap: round; opacity:.6;
    filter: drop-shadow(0 6px 10px rgba(0,0,0,.08));
  }
  .node .base{ stroke:#182033; stroke-opacity:.1}
  .node:focus .focus{
    opacity:1;
  }
  .focus{opacity:0; transition: .12s opacity ease}
  .node:hover .focus{opacity:1}
  .node:hover .face, .node:focus .face{
    transform: translateY(-2px);
  }
  .face{transition: transform .15s ease}
  .label{
    font-size: 28px; font-weight: 800; text-anchor: middle; fill: #1b2a3e;
  }
  .shadow{
    filter: drop-shadow(0 8px 16px rgba(0,0,0,.12));
  }
  .connector{stroke:#bcd0ff; stroke-width:10; fill:none; stroke-linecap:round}
  .connector.glow{stroke:#e3ecff; stroke-width:16; opacity:.8}
  .pulse{animation: pulse .35s ease}
  @keyframes pulse{
    0%{transform:translateY(0) scale(1)}
    50%{transform:translateY(-6px) scale(1.04)}
    100%{transform:translateY(0) scale(1)}
  }
  .shake{animation: shake .25s ease}
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    25%{transform:translateX(-6px)}
    75%{transform:translateX(6px)}
  }
  .good{color:var(--good)}
  .bad{color:var(--bad)}
  .target{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    font-weight:700;
  }
  .target .bubble{
    background:#ffffff;
    border: 2px solid #e5ecff;
    color:#15233a;
    padding: 6px 10px;
    border-radius: 10px;
  }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-weight:800; font-size:12px;
    padding:2px 6px; border:1px solid #d8e2ff; border-radius:6px; background:#f7faff; color:#243250;
  }
  .footer{
    font-size:12px; color:#6d7a90; text-align:center; padding:10px 8px 14px;
  }
  .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  .overlay{
    position:fixed;inset:0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(4px);
    display:grid; place-items:center;
    padding:24px;
    z-index:50;
    animation: fadeIn .3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .panel{
    width:min(420px, 92vw);
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.22);
    padding: clamp(24px, 5vw, 40px);
    text-align:center;
    border: 1px solid rgba(0,0,0,0.05);
    transform: scale(0.95) translateY(10px);
    animation: popIn .3s ease forwards;
  }
  @keyframes popIn {
    to { transform: scale(1) translateY(0); }
  }
  .panel h2{
    margin:0 0 12px 0;
    font-size: clamp(28px, 6vw, 40px);
    color: var(--accent);
    font-family: 'Luckiest Guy', cursive;
    letter-spacing: 1.5px;
    text-shadow: 0 3px 5px rgba(0,0,0,0.1);
    text-transform: uppercase;
    font-weight: bold;
  }
  .panel p{
    margin:0 0 24px;
    color: #555;
    font-size: clamp(16px, 2.8vw, 19px);
    line-height:1.6;
  }
  .badgeRow{
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
    margin: 24px 0;
    padding: 16px;
    background: #f7f7f7;
    border-radius: 16px;
  }
  .mini{
    background: #fff;
    border: 1px solid #eee;
    border-radius:12px;
    padding:10px 16px;
    box-shadow: 0 3px 6px rgba(0,0,0,.05);
    display:flex; align-items:center; gap:10px;
    font-weight:700;
    color:#444;
    font-size: clamp(13px, 2vw, 15px);
    transition: transform .2s ease;
  }
  .mini:hover{
    transform: translateY(-2px);
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <div class="title">
        <div style="display: flex; align-items: center; gap: 12px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="var(--accent)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-6h4v-2h-4v2zm-4-4h12v-2H6v2zm4-4h4V8h-4V6z"/></svg>
          <h1>√Årbol de Familia</h1>
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="var(--accent)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-6h4v-2h-4v2zm-4-4h12v-2H6v2zm4-4h4V8h-4V6z"/></svg>
        </div>
      </div>
      <div class="controls">
        <div class="select-wrapper" style="margin-right: auto;">
          <select id="voiceSelect" title="Seleccionar voz (Espa√±ol)"></select>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <div class="score" id="scoreBox" aria-live="polite">Puntuaci√≥n: 0</div>
          <button id="challengeBtn" class="accent pill">Iniciar Reto</button>
        </div>
      </div>
    </header>

    <div class="bar">
      <div class="target" id="targetBox">
        <span class="bubble">Consejo: usa las teclas <span class="kbd">1</span>, <span class="kbd">2</span>, <span class="kbd">3</span> o flechas + Enter</span>
      </div>
    </div>

    <div class="board" id="board">
      <svg viewBox="0 0 1000 700" role="img" aria-label="√Årbol familiar interactivo en espa√±ol">
        <defs>
          <linearGradient id="bgp" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#8fb6ff"/>
            <stop offset="1" stop-color="#4c7dff"/>
          </linearGradient>
          <linearGradient id="bgm" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#ffabc9"/>
            <stop offset="1" stop-color="#ff6aa7"/>
          </linearGradient>
          <linearGradient id="bgb" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#67e7b3"/>
            <stop offset="1" stop-color="#29c491"/>
          </linearGradient>
        </defs>

        <g id="level1">
          <path class="connector glow" d="M300 280 C 320 420, 450 440, 500 480"/>
          <path class="connector glow" d="M700 280 C 680 420, 550 440, 500 480"/>
          <path class="connector" d="M300 280 C 320 420, 450 440, 500 480"/>
          <path class="connector" d="M700 280 C 680 420, 550 440, 500 480"/>

          <g id="padre" class="node" role="button" tabindex="0" aria-label="el padre" data-es="el padre" data-en="father" data-key="1" transform="translate(300,200)">
            <circle class="ring" cx="0" cy="0" r="86" stroke="url(#bgp)"></circle>
            <circle class="focus" cx="0" cy="0" r="96" fill="none" stroke="#a9c3ff" stroke-width="6"></circle>
            <g class="face shadow">
              <circle class="base" cx="0" cy="0" r="72" fill="#fee1c7"></circle>
              <rect x="-50" y="-78" width="100" height="46" rx="12" fill="#2e3a59"></rect>
              <circle cx="-28" cy="-6" r="6" fill="#2e3a59"></circle>
              <circle cx="28" cy="-6" r="6" fill="#2e3a59"></circle>
              <path d="M-18 16 Q0 28 18 16" fill="none" stroke="#c46a3b" stroke-width="6" stroke-linecap="round"/>
              <path d="M-20 8 Q0 18 20 8" stroke="#2e3a59" stroke-width="6" stroke-linecap="round" fill="none"/>
              <rect x="-14" y="60" width="28" height="22" rx="6" fill="#4c7dff"/>
              <path d="M0 82 L-10 102 L10 102 Z" fill="#2f53c7"/>
            </g>
            <text class="label" x="0" y="140">el padre <tspan fill="#6b7a90" font-size="16">(1)</tspan></text>
          </g>

          <g id="madre" class="node" role="button" tabindex="0" aria-label="la madre" data-es="la madre" data-en="mother" data-key="2" transform="translate(700,200)">
            <circle class="ring" cx="0" cy="0" r="86" stroke="url(#bgm)"></circle>
            <circle class="focus" cx="0" cy="0" r="96" fill="none" stroke="#ffc1da" stroke-width="6"></circle>
            <g class="face shadow">
              <circle class="base" cx="0" cy="0" r="72" fill="#ffe7d5"></circle>
              <path d="M-70 -10 Q0 -100 70 -10 Q40 10 -40 10 Z" fill="#c13d66"/>
              <circle cx="-26" cy="-6" r="6" fill="#2e3a59"></circle>
              <circle cx="26" cy="-6" r="6" fill="#2e3a59"></circle>
              <path d="M-18 18 Q0 28 18 18" fill="none" stroke="#d67858" stroke-width="6" stroke-linecap="round"/>
              <path d="M-36 -12 q8 -10 16 0 M20 -12 q8 -10 16 0" stroke="#2e3a59" stroke-width="3" fill="none" stroke-linecap="round"/>
              <rect x="-22" y="58" width="44" height="24" rx="8" fill="#ff6aa7"/>
            </g>
            <text class="label" x="0" y="140">la madre <tspan fill="#6b7a90" font-size="16">(2)</tspan></text>
          </g>

          <g id="bebe" class="node" role="button" tabindex="0" aria-label="el beb√©" data-es="el beb√©" data-en="baby" data-key="3" transform="translate(500,500)">
            <circle class="ring" cx="0" cy="0" r="86" stroke="url(#bgb)"></circle>
            <circle class="focus" cx="0" cy="0" r="96" fill="none" stroke="#a8f0d3" stroke-width="6"></circle>
            <g class="face shadow">
              <circle class="base" cx="0" cy="0" r="72" fill="#ffe9d9"></circle>
              <path d="M-6 -60 Q0 -75 6 -60" stroke="#a37146" stroke-width="6" fill="none" stroke-linecap="round"/>
              <circle cx="-22" cy="-6" r="6" fill="#2e3a59"></circle>
              <circle cx="22" cy="-6" r="6" fill="#2e3a59"></circle>
              <path d="M-12 18 Q0 12 12 18" fill="none" stroke="#d07b52" stroke-width="6" stroke-linecap="round"/>
              <circle cx="0" cy="32" r="12" fill="#7fd9b1" stroke="#3aa879" stroke-width="4"></circle>
              <circle cx="0" cy="32" r="4" fill="#3aa879"></circle>
            </g>
            <text class="label" x="0" y="140">el beb√© <tspan fill="#6b7a90" font-size="16">(3)</tspan></text>
          </g>
        </g>

        <g id="level2" style="display: none;">
            <path class="connector glow" d="M500 280 C 450 380, 350 420, 300 480"/>
            <path class="connector glow" d="M500 280 C 550 380, 650 420, 700 480"/>
            <path class="connector" d="M500 280 C 450 380, 350 420, 300 480"/>
            <path class="connector" d="M500 280 C 550 380, 650 420, 700 480"/>

            <g id="abuela" class="node" role="button" tabindex="0" aria-label="la abuela" data-es="la abuela" data-en="grandmother" data-key="1" transform="translate(500,200)">
                <circle class="ring" cx="0" cy="0" r="86" stroke="url(#bgm)"></circle>
                <circle class="focus" cx="0" cy="0" r="96" fill="none" stroke="#ffc1da" stroke-width="6"></circle>
                <g class="face shadow">
                    <circle class="base" cx="0" cy="0" r="72" fill="#ffe7d5"></circle>
                    <path d="M-40 -50 Q0 -80 40 -50 C 50 -20, -50 -20, -40 -50 Z" fill="#d1d5db"></path>
                    <circle cx="-26" cy="-6" r="6" fill="#2e3a59"></circle>
                    <circle cx="26" cy="-6" r="6" fill="#2e3a59"></circle>
                    <path d="M-18 18 Q0 28 18 18" fill="none" stroke="#d67858" stroke-width="6" stroke-linecap="round"/>
                    <path d="M-30 -20 C -20 -30, 20 -30, 30 -20" fill="none" stroke="#9ca3af" stroke-width="4" stroke-linecap="round"/>
                </g>
                <text class="label" x="0" y="140">la abuela <tspan fill="#6b7a90" font-size="16">(1)</tspan></text>
            </g>

            <g id="hermano" class="node" role="button" tabindex="0" aria-label="el hermano" data-es="el hermano" data-en="brother" data-key="2" transform="translate(300,500)">
                <circle class="ring" cx="0" cy="0" r="86" stroke="url(#bgp)"></circle>
                <circle class="focus" cx="0" cy="0" r="96" fill="none" stroke="#a9c3ff" stroke-width="6"></circle>
                <g class="face shadow">
                    <circle class="base" cx="0" cy="0" r="72" fill="#fee1c7"></circle>
                    <rect x="-50" y="-78" width="100" height="46" rx="12" fill="#a37146"></rect>
                    <circle cx="-28" cy="-6" r="6" fill="#2e3a59"></circle>
                    <circle cx="28" cy="-6" r="6" fill="#2e3a59"></circle>
                    <path d="M-18 16 Q0 28 18 16" fill="none" stroke="#c46a3b" stroke-width="6" stroke-linecap="round"/>
                </g>
                <text class="label" x="0" y="140">el hermano <tspan fill="#6b7a90" font-size="16">(2)</tspan></text>
            </g>

            <g id="hermana" class="node" role="button" tabindex="0" aria-label="la hermana" data-es="la hermana" data-en="sister" data-key="3" transform="translate(700,500)">
                <circle class="ring" cx="0" cy="0" r="86" stroke="url(#bgb)"></circle>
                <circle class="focus" cx="0" cy="0" r="96" fill="none" stroke="#a8f0d3" stroke-width="6"></circle>
                <g class="face shadow">
                    <circle class="base" cx="0" cy="0" r="72" fill="#ffe9d9"></circle>
                    <path d="M-60 -20 Q-40 -80 0 -60 Q40 -80 60 -20 Q0 20 -60 -20 Z" fill="#c13d66"></path>
                    <circle cx="-22" cy="-6" r="6" fill="#2e3a59"></circle>
                    <circle cx="22" cy="-6" r="6" fill="#2e3a59"></circle>
                    <path d="M-12 18 Q0 12 12 18" fill="none" stroke="#d07b52" stroke-width="6" stroke-linecap="round"/>
                </g>
                <text class="label" x="0" y="140">la hermana <tspan fill="#6b7a90" font-size="16">(3)</tspan></text>
            </g>
        </g>
      </svg>
    </div>

    <div class="footer">
      Toca los iconos para escuchar. Si no oyes la voz, elige otra voz de "Seleccionar voz". Compatible con la mayor√≠a de navegadores modernos.
    </div>
  </div>
</div>

<div id="live" class="sr" aria-live="polite"></div>

<div class="overlay" id="startOverlay">
  <div class="panel">
    <h2>√Årbol de Familia</h2>
    <p>Aprende los miembros de la familia en espa√±ol.</p>
    <div class="badgeRow">
      <div class="mini">üëÜ Toca para escuchar</div>
      <div class="mini">‚å®Ô∏è Usa 1, 2, 3</div>
      <div class="mini">üéØ Inicia un reto</div>
    </div>
    <div style="display: flex; justify-content: center; margin-top: 28px;">
      <button id="startBtn" class="accent" style="font-size: clamp(18px, 3.5vw, 24px); padding: 16px 28px; box-shadow: 0 8px 20px rgba(76,125,255,.4);">¬°Vamos!</button>
    </div>
  </div>
</div>

<script>
(function(){
  const levels = [
    {
      nodes: [
        {id:'padre', es:'el padre', en:'father'},
        {id:'madre', es:'la madre', en:'mother'},
        {id:'bebe',  es:'el beb√©',  en:'baby'}
      ],
      order: ['padre','madre','bebe'],
      neighbor: {
        padre:{left:'bebe', right:'madre', up:'padre', down:'bebe'},
        madre:{left:'padre', right:'bebe', up:'madre', down:'bebe'},
        bebe:{left:'padre', right:'madre', up:'padre', down:'bebe'}
      }
    },
    {
      nodes: [
        {id:'abuela', es:'la abuela', en:'grandmother'},
        {id:'hermano', es:'el hermano', en:'brother'},
        {id:'hermana',  es:'la hermana',  en:'sister'}
      ],
      order: ['abuela', 'hermano', 'hermana'],
      neighbor: {
        abuela:{left:'hermano', right:'hermana', up:'abuela', down:'hermano'},
        hermano:{left:'hermana', right:'abuela', up:'abuela', down:'hermano'},
        hermana:{left:'abuela', right:'hermano', up:'abuela', down:'hermana'}
      }
    }
  ];
  let currentLevelIndex = 0;
  let nodes, order, neighbor;

  const voiceSelect = document.getElementById('voiceSelect');
  const challengeBtn = document.getElementById('challengeBtn');
  const targetBox = document.getElementById('targetBox');
  const scoreBox = document.getElementById('scoreBox');
  const live = document.getElementById('live');
  const startOverlay = document.getElementById('startOverlay');
  const startBtn = document.getElementById('startBtn');
  let currentMode = 'practice';
  let score = 0;
  let targetId = null;
  let voices = [];
  let chosenVoice = null;

  function loadLevel(levelIndex) {
    currentLevelIndex = levelIndex;
    const levelData = levels[levelIndex];
    nodes = levelData.nodes;
    order = levelData.order;
    neighbor = levelData.neighbor;

    // Hide all level graphics
    document.getElementById('level1').style.display = 'none';
    document.getElementById('level2').style.display = 'none';
    // Show current level graphics
    document.getElementById(`level${levelIndex + 1}`).style.display = 'block';

    attachInteractions();
    setMode('practice');
    setTimeout(()=>focusNode(order[0]), 300);
  }


  function populateVoices(){
    voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
    const esVoices = voices.filter(v => (v.lang || '').toLowerCase().startsWith('es'));
    voiceSelect.innerHTML = '';
    if(esVoices.length){
      esVoices.forEach((v, i)=>{
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
      // Prefer es-ES, else first
      const preferred = esVoices.find(v => v.lang.toLowerCase().includes('es-es')) || esVoices[0];
      chosenVoice = preferred;
      voiceSelect.value = preferred.name;
    }else{
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Voz predeterminada (es-ES)';
      voiceSelect.appendChild(opt);
      chosenVoice = null;
    }
  }

  function speak(text){
    if(!('speechSynthesis' in window)) { feedback('Tu navegador no soporta voz.'); return; }
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'es-ES';
      u.rate = 0.95;
      u.pitch = 1.05;
      if(chosenVoice){
        const match = voices.find(v=>v.name===chosenVoice.name);
        if(match) u.voice = match;
      }
      speechSynthesis.speak(u);
    }catch(e){}
  }

  function feedback(msg){
    live.textContent = msg;
  }

  function setMode(mode){
    currentMode = mode;
    if(mode==='practice'){
      challengeBtn.textContent = 'Iniciar Reto';
      targetBox.innerHTML = `<span class="bubble">Consejo: usa las teclas <span class="kbd">1</span>, <span class="kbd">2</span>, <span class="kbd">3</span> o flechas + Enter</span>`;
      score = 0;
      scoreBox.textContent = 'Puntuaci√≥n: 0';
      targetId = null;
    }else{
      challengeBtn.textContent = 'Reiniciar';
      score = 0;
      scoreBox.textContent = 'Puntuaci√≥n: 0';
      nextTarget();
    }
  }

  function nextTarget(){
    const ids = order.slice();
    if(targetId){
      // avoid repeating
      const idx = ids.indexOf(targetId);
      if(idx>=0) ids.splice(idx,1);
    }
    targetId = ids[Math.floor(Math.random()*ids.length)];
    const member = nodes.find(n=>n.id===targetId);
    targetBox.innerHTML = `
      <span>Busca:</span>
      <span class="bubble"><b>${member.es}</b> ¬∑ ${member.en}</span>
      <button id="hearBtn" class="muted pill" style="font-weight:700">Escuchar</button>
    `;
    document.getElementById('hearBtn').addEventListener('click', ()=>{
      speak(member.es);
      pulse(targetId);
    }, {passive:true});
  }

  function pulse(id){
    const g = document.getElementById(id);
    if(!g) return;
    g.classList.remove('pulse');
    // Force reflow
    void g.offsetWidth;
    g.classList.add('pulse');
  }

  function shake(id){
    const g = document.getElementById(id);
    if(!g) return;
    g.classList.remove('shake');
    void g.offsetWidth;
    g.classList.add('shake');
  }

  function handleSelect(id){
    const g = document.getElementById(id);
    if(!g) return;
    const term = g.getAttribute('data-es');
    speak(term);
    pulse(id);
    if(currentMode==='challenge'){
      if(id===targetId){
        score++;
        scoreBox.textContent = `Puntuaci√≥n: ${score}`;
        targetBox.innerHTML = `<span class="good" style="font-weight:800">¬°Correcto!</span> <span class="bubble"><b>${term}</b></span>`;
        
        if (score >= 3) {
          if (currentLevelIndex < levels.length - 1) {
            targetBox.innerHTML += `<button id="nextLevelBtn" class="accent pill" style="margin-left: 10px;">Siguiente Nivel</button>`;
            document.getElementById('nextLevelBtn').addEventListener('click', () => {
              loadLevel(currentLevelIndex + 1);
            });
          } else {
            targetBox.innerHTML += `<span style="margin-left: 10px; font-weight: bold;">¬°Juego Completado!</span>`;
          }
        } else {
          setTimeout(nextTarget, 850);
        }
      }else{
        shake(id);
        targetBox.innerHTML = `<span class="bad" style="font-weight:800">Int√©ntalo de nuevo</span> <span class="bubble"><b>${nodes.find(n=>n.id===targetId).es}</b></span>`;
      }
    }
  }

  function attachInteractions(){
    order.forEach(id=>{
      const g = document.getElementById(id);
      // Clear old listeners before attaching new ones to be safe
      const new_g = g.cloneNode(true);
      g.parentNode.replaceChild(new_g, g);

      new_g.addEventListener('click', ()=>handleSelect(id));
      new_g.addEventListener('pointerdown', (e)=>{ /* for mobile active */ });
      new_g.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          handleSelect(id);
        }else if(e.key==='ArrowLeft' || e.key==='ArrowRight' || e.key==='ArrowUp' || e.key==='ArrowDown'){
          e.preventDefault();
          const next = neighbor[id][e.key.replace('Arrow','').toLowerCase()];
          focusNode(next);
        }
      });
    });
  }

  function focusNode(id){
    const g = document.getElementById(id);
    if(g){ g.focus({preventScroll:true}); }
  }

  // Global keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    const key = e.key;
    if(order.length >= 1 && key==='1'){ handleSelect(order[0]); }
    if(order.length >= 2 && key==='2'){ handleSelect(order[1]); }
    if(order.length >= 3 && key==='3'){ handleSelect(order[2]); }
  });

  // Buttons
  challengeBtn.addEventListener('click', ()=>{
    setMode(currentMode === 'practice' ? 'challenge' : 'practice');
  });

  startBtn.addEventListener('click', () => {
    startOverlay.style.display = 'none';
    warm();
    focusNode(order[0]);
  });

  // Voice handling
  populateVoices();
  if('speechSynthesis' in window){
    speechSynthesis.onvoiceschanged = ()=>{
      populateVoices();
    };
  }
  voiceSelect.addEventListener('change', ()=>{
    const name = voiceSelect.value;
    chosenVoice = voices.find(v=>v.name===name) || null;
    const sample = targetId ? nodes.find(n=>n.id===targetId).es : 'Bienvenido';
    speak(sample);
  });

  // Initial Load
  loadLevel(0);

  // iOS warm-up: speak after first user gesture if needed
  let warmed = false;
  function warm(){
    if(warmed) return;
    warmed = true;
    if(currentMode==='practice'){
      // gentle cue without speaking loudly: do nothing or small utterance
    }
  }
  window.addEventListener('pointerdown', warm, {once:true, passive:true});
})();
</script>
</body>
</html>