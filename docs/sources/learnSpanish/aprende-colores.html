<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Colores en Espa√±ol - Juego para peques</title>
<style>
  :root{
    --bg1:#f6f9ff;
    --bg2:#e9f2ff;
    --ink:#20304a;
    --accent:#ffb703;
    --good:#00c853;
    --bad:#ff5252;
    --card:#ffffff;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--ink);
    background: radial-gradient(1200px 800px at 15% -20%, var(--bg2), transparent 70%),
                radial-gradient(1000px 700px at 120% 0%, #fff2f2, transparent 60%),
                linear-gradient(180deg, var(--bg1), #ffffff 60%);
  }
  .wrap{
    max-width:980px;
    margin:0 auto;
    padding: clamp(10px, 2vw, 20px);
    display:flex;
    flex-direction:column;
    gap: clamp(10px, 2vw, 16px);
    min-height:100%;
  }
  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .title{
    display:flex;align-items:center;gap:10px;
    font-weight:900;
    letter-spacing:.3px;
    font-size: clamp(20px, 3vw, 32px);
  }
  .title .spark{
    width:36px;height:36px;border-radius:50%;
    background: conic-gradient(from 210deg, #ff3d71, #ffc107, #00e5ff, #7c4dff, #ff3d71);
    box-shadow:0 6px 18px rgba(0,0,0,.12) inset, 0 2px 8px rgba(0,0,0,.08);
  }
  .hud{
    display:flex;align-items:center;gap:10px;
  }
  .hud .btn{
    border:none;border-radius:14px;
    padding:10px 14px;
    background:var(--card);
    box-shadow:0 8px 20px rgba(0,0,0,.08);
    font-weight:700;color:var(--ink);
    cursor:pointer;
    display:flex;align-items:center;gap:8px;
  }
  .hud .btn:active{transform:scale(.98)}
  .score{
    display:flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:14px;background:var(--card);
    box-shadow:0 8px 20px rgba(0,0,0,.08);
    font-weight:800;
  }
  .star{
    width:22px;height:22px;display:inline-block;
    background: radial-gradient(circle at 30% 30%, #ffe082, #ffb300 60%);
    clip-path: polygon(50% 0%, 62% 34%, 98% 35%, 69% 57%, 79% 91%, 50% 72%, 21% 91%, 31% 57%, 2% 35%, 38% 34%);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,.2));
  }
  main{
    display:grid;
    grid-template-columns: 1fr;
    gap: clamp(14px, 2.6vw, 20px);
    flex:1;
  }
  .stage{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap: clamp(14px, 2.6vw, 20px);
  }
  @media (max-width:800px){
    .stage{grid-template-columns:1fr}
  }
  .card{
    background:var(--card);
    border-radius:24px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);
    padding: clamp(14px, 3vw, 24px);
  }
  .picture{
    display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:320px;gap:14px;
    position:relative;overflow:hidden;
  }
  .clouds::before, .clouds::after{
    content:""; position:absolute; inset:auto auto 10% -10%;
    width:220px;height:220px;border-radius:50%;
    background: radial-gradient(closest-side, #ffffff, #ffffff 70%, transparent 72%);
    opacity:.6; filter: blur(4px);
  }
  .clouds::after{left:auto;right:-10%; bottom:18%}
  .prompt{
    font-weight:900; text-align:center; font-size: clamp(18px, 2.6vw, 24px);
  }
  .bigIcon{
    width:min(70vmin, 420px);
    max-width:100%;
    aspect-ratio: 1 / 1;
    display:grid;place-items:center;
    position:relative;
  }
  .bigIcon svg{
    width:80%;height:80%;
    filter: drop-shadow(0 18px 28px rgba(0,0,0,.18));
  }
  .listenRow{
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center;
  }
  .speak{
    display:flex;align-items:center;justify-content:center;
    border:none;border-radius:999px;
    padding:12px 18px;
    background:#1fd1ff;
    color:#022;
    font-weight:900;font-size:18px;
    box-shadow:0 10px 18px rgba(0,0,0,.15);
    cursor:pointer;
  }
  .speak:active{transform:scale(.98)}
  .speak .ico{
    width:24px;height:24px;display:inline-block;position:relative;
  }
  .speak .ico::before, .speak .ico::after{
    content:""; position:absolute; left:8px; top:3px; width:10px; height:18px; border-radius:3px;
    background: currentColor; transform:skewX(-10deg);
  }
  .speak .ico::after{
    left:auto; right:-8px; width:2px; background:transparent;
    box-shadow:
      0 0 0 0 currentColor,
      3px -4px 0 -1px currentColor,
      6px 0 0 -1px currentColor,
      3px 4px 0 -1px currentColor;
  }
  .options{
    display:grid;grid-template-columns: repeat(2, 1fr);gap: clamp(10px, 2.6vw, 16px);
  }
  @media (min-width:700px){
    .options{grid-template-columns: repeat(4, 1fr);}
  }
  .opt{
    border:none;border-radius:22px; padding:16px 12px; min-height:88px;
    font-size: clamp(16px, 2.2vw, 20px); font-weight:900;
    color:#111; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:10px;
    box-shadow: 0 12px 22px rgba(0,0,0,.12), inset 0 2px 0 rgba(255,255,255,.5);
    transform: translateZ(0);
    transition: transform .05s ease, box-shadow .2s ease, filter .2s ease;
  }
  .opt:active{transform: scale(.98)}
  .swatch{width:26px;height:26px;border-radius:50%; border:2px solid rgba(0,0,0,.1); box-shadow: inset 0 2px 4px rgba(255,255,255,.5)}
  .opt[disabled]{opacity:.5}
  .opt.good{box-shadow:0 12px 22px rgba(0,200,83,.32)}
  .opt.bad{animation: shake .3s linear 1}
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    25%{transform:translateX(-5px)}
    75%{transform:translateX(5px)}
  }
  .pill{
    display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;background:#eef6ff;color:#0b355b;font-weight:700;font-size:14px;
  }
  .kbd{
    background:#fff;border-radius:8px;padding:2px 6px;border:1px solid #d4d9e2; box-shadow:0 1px 0 #fff inset;
    font-weight:800; font-size:12px;
  }
  .footer{
    display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;font-size:14px;opacity:.85;
  }
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center; background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.9));
    z-index:50; padding:20px;
  }
  .modal{
    background:var(--card); border-radius:28px; padding:24px; max-width:640px; width:min(92vw, 640px);
    box-shadow:0 20px 50px rgba(0,0,0,.18);
    text-align:center;
    display:flex;flex-direction:column;gap:16px;
  }
  .modal h1{
    margin:0;font-size: clamp(22px, 4vw, 34px); letter-spacing:.2px;
  }
  .modal p{margin:0; line-height:1.5}
  .cta{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    background:linear-gradient(180deg, #35e0a1, #00c774);
    color:white; font-weight:900; font-size:18px; padding:14px 18px; border:none; border-radius:16px; cursor:pointer;
    box-shadow:0 14px 28px rgba(0,199,116,.35);
  }
  .cta:active{transform:scale(.98)}
  .cele{
    position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:40;
  }
  .particle{
    position:absolute; width:16px;height:16px; border-radius:50%;
    transform: translate(-50%, -50%) scale(0);
    animation: pop .7s ease forwards;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,.2));
  }
  @keyframes pop{
    0%{transform:translate(-50%,-50%) scale(0); opacity:1}
    70%{opacity:1}
    100%{transform:translate(var(--tx), var(--ty)) scale(1); opacity:0}
  }
  .toast{
    position:fixed; left:50%; top:18px; transform:translateX(-50%);
    background:#111; color:#fff; padding:10px 14px; border-radius:999px; font-weight:800; font-size:14px; opacity:0; pointer-events:none;
    transition: opacity .2s ease, transform .2s ease; z-index:60;
  }
  .toast.show{opacity:1; transform:translate(-50%, 0)}
  .muted{opacity:.6}
  .sr-only{
    position:absolute !important; height:1px;width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; clip-path:inset(50%); border:0; padding:0; margin:-1px;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title"><span class="spark" aria-hidden="true"></span> Colores en Espa√±ol</div>
    <div class="hud">
      <div class="score" aria-live="polite"><span class="star" aria-hidden="true"></span> <span id="scoreVal">0</span></div>
      <button id="muteBtn" class="btn" aria-pressed="false" aria-label="Sonido activado">
        üîä Sonido
      </button>
      <button id="helpBtn" class="btn" aria-label="C√≥mo jugar">‚ùî Ayuda</button>
    </div>
  </header>

  <main>
    <div class="stage">
      <section class="card picture clouds">
        <div class="prompt">¬øQu√© color es?</div>
        <div class="bigIcon" id="iconArea" aria-live="polite" aria-label="Dibujo con un color"></div>
        <div class="listenRow">
          <button id="speakBtn" class="speak" aria-label="Escuchar el color (Espacio)">
            <span class="ico" aria-hidden="true"></span>
            Escuchar
            <span class="pill"><span class="kbd">Espacio</span></span>
          </button>
        </div>
      </section>

      <section class="card">
        <div class="prompt" style="margin-bottom:8px">Toca el color correcto</div>
        <div id="options" class="options" role="group" aria-label="Opciones de color"></div>
      </section>
    </div>
  </main>

  <div class="footer">
    - Toca un bot√≥n o usa 1 ‚Ä¢ 2 ‚Ä¢ 3 ‚Ä¢ 4 - Repite el sonido con Espacio -
  </div>
</div>

<div class="overlay" id="startOverlay">
  <div class="modal">
    <h1>¬°Aprende los colores en espa√±ol!</h1>
    <p>Escucha el color y toca el bot√≥n correcto. Botones grandes, sonidos felices y dibujos coloridos.</p>
    <p>
      Controles:
      <span class="pill"><span class="kbd">1</span><span class="kbd">2</span><span class="kbd">3</span><span class="kbd">4</span> elige</span>
      <span class="pill"><span class="kbd">Espacio</span> escuchar</span>
    </p>
    <button id="startBtn" class="cta">¬°Empezar!</button>
  </div>
</div>

<div class="cele" id="cele"></div>
<div class="toast" id="toast">¬°Muy bien!</div>

<script>
(function(){
  const colors = [
    {id:'rojo', es:'rojo', en:'red', hex:'#e53935', shape:'apple'},
    {id:'azul', es:'azul', en:'blue', hex:'#1e88e5', shape:'fish'},
    {id:'verde', es:'verde', en:'green', hex:'#43a047', shape:'leaf'},
    {id:'amarillo', es:'amarillo', en:'yellow', hex:'#fdd835', shape:'star'},
    {id:'naranja', es:'naranja', en:'orange', hex:'#fb8c00', shape:'orange'},
    {id:'morado', es:'morado', en:'purple', hex:'#8e24aa', shape:'butterfly'},
    {id:'rosa', es:'rosa', en:'pink', hex:'#ec407a', shape:'heart'},
    {id:'negro', es:'negro', en:'black', hex:'#212121', shape:'cat'},
    {id:'blanco', es:'blanco', en:'white', hex:'#ffffff', shape:'cloud'},
    {id:'marr√≥n', es:'marr√≥n', en:'brown', hex:'#6d4c41', shape:'bear'}
  ];

  const iconArea = document.getElementById('iconArea');
  const optionsEl = document.getElementById('options');
  const speakBtn = document.getElementById('speakBtn');
  const muteBtn = document.getElementById('muteBtn');
  const helpBtn = document.getElementById('helpBtn');
  const startBtn = document.getElementById('startBtn');
  const startOverlay = document.getElementById('startOverlay');
  const cele = document.getElementById('cele');
  const toast = document.getElementById('toast');
  const scoreVal = document.getElementById('scoreVal');

  let audioCtx = null, muted = false, voice = null;
  let current = null, roundOptions = [];
  let score = 0;
  let lastId = null;

  function pickVoice(){
    const vs = speechSynthesis.getVoices();
    const preferred = vs.find(v=>/^es(-|_|$)/i.test(v.lang) && v.name.toLowerCase().includes('child')) ||
                      vs.find(v=>/^es(-|_|$)/i.test(v.lang)) ||
                      vs.find(v=>v.lang && v.lang.toLowerCase().startsWith('es'));
    voice = preferred || null;
  }

  function speak(text){
    if(muted) return;
    try{
      if(!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = (voice && voice.lang) || 'es-ES';
      if(voice) u.voice = voice;
      u.rate = 0.9;
      u.pitch = 1.05;
      u.volume = 1;
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function initAudio(){
    if(!audioCtx){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }catch(e){}
    }
    if(audioCtx && audioCtx.state === 'suspended'){
      audioCtx.resume();
    }
  }

  function tone(freq=660, dur=0.12, type='sine', gain=0.08, t0){
    if(!audioCtx || muted) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = 0;
    o.connect(g); g.connect(audioCtx.destination);
    const now = t0 || audioCtx.currentTime;
    g.gain.linearRampToValueAtTime(gain, now + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
    o.start(now);
    o.stop(now + dur + 0.02);
  }

  function successSound(){
    if(!audioCtx || muted) return;
    const now = audioCtx.currentTime;
    const seq = [660, 880, 990];
    seq.forEach((f,i)=>tone(f, 0.12, 'sine', 0.08, now + i*0.12));
  }

  function errorSound(){
    if(!audioCtx || muted) return;
    const now = audioCtx.currentTime;
    tone(220, 0.18, 'sawtooth', 0.06, now);
    tone(180, 0.20, 'triangle', 0.06, now+0.05);
  }

  function vibrate(ms){ if(navigator.vibrate) try{ navigator.vibrate(ms) }catch(e){} }

  function contrastColor(hex){
    const c = hex.replace('#','');
    const r = parseInt(c.substr(0,2),16);
    const g = parseInt(c.substr(2,2),16);
    const b = parseInt(c.substr(4,2),16);
    const lum = (0.299*r + 0.587*g + 0.114*b)/255;
    return lum > 0.6 ? '#1a1a1a' : '#ffffff';
  }

  function renderIcon(shape, color){
    const stroke = color.toLowerCase() === '#ffffff' ? '#d9d9d9' : 'rgba(0,0,0,.12)';
    const darkStroke = color.toLowerCase() === '#ffffff' ? '#bdbdbd' : 'rgba(0,0,0,.25)';
    const accent = '#ffffff';
    const commonAttrs = `stroke="${darkStroke}" stroke-width="2"`;
    let svg = '';
    switch(shape){
      case 'apple':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <defs>
              <filter id="s1" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="6" stdDeviation="4" flood-opacity=".25"/>
              </filter>
            </defs>
            <g filter="url(#s1)">
              <path d="M50,18 C53,11 60,10 66,12 C66,12 61,18 58,23" fill="${color}" ${commonAttrs}/>
              <path d="M50,25 C35,20 18,32 18,52 C18,73 33,86 50,86 C67,86 82,73 82,52 C82,32 65,20 50,25 Z" fill="${color}" ${commonAttrs}/>
              <path d="M52 19 C55 10 62 9 70 11" stroke="${darkStroke}" stroke-width="3" fill="none" stroke-linecap="round"/>
              <ellipse cx="40" cy="50" rx="4" ry="3" fill="${accent}" opacity=".2"/>
            </g>
          </svg>
        `;
        break;
      case 'fish':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <g>
              <ellipse cx="50" cy="55" rx="30" ry="20" fill="${color}" ${commonAttrs}/>
              <polygon points="22,55 8,44 8,66" fill="${color}" stroke="${darkStroke}" stroke-width="2" stroke-linejoin="round"/>
              <circle cx="58" cy="50" r="3" fill="${contrastColor(color)}" opacity=".8"/>
              <path d="M62 60 C70 62, 78 60, 86 55" stroke="${darkStroke}" stroke-width="2" fill="none"/>
            </g>
          </svg>
        `;
        break;
      case 'star':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <polygon points="50,8 61,38 92,38 66,57 76,86 50,68 24,86 34,57 8,38 39,38"
              fill="${color}" stroke="${darkStroke}" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        `;
        break;
      case 'heart':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <path d="M50 82 C45 74, 22 63, 16 45 C12 32, 21 20, 34 20 C43 20, 47 25, 50 30
                     C53 25, 57 20, 66 20 C79 20, 88 32, 84 45 C78 63, 55 74, 50 82 Z"
              fill="${color}" ${commonAttrs}/>
          </svg>
        `;
        break;
      case 'butterfly':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <ellipse cx="35" cy="50" rx="22" ry="18" fill="${color}" ${commonAttrs}/>
            <ellipse cx="65" cy="50" rx="22" ry="18" fill="${color}" ${commonAttrs}/>
            <rect x="47" y="38" width="6" height="24" rx="3" fill="${contrastColor(color)}" opacity=".5"/>
            <path d="M50 38 C49 32, 45 28, 42 26 M50 38 C51 32, 55 28, 58 26" stroke="${darkStroke}" stroke-width="2" fill="none" stroke-linecap="round"/>
          </svg>
        `;
        break;
      case 'leaf':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <path d="M50 18 C28 22, 16 40, 18 58 C20 76, 40 86, 58 82 C76 78, 88 60, 86 42 C84 24, 66 14, 50 18 Z"
              fill="${color}" ${commonAttrs}/>
            <path d="M28 56 C44 52, 58 44, 72 32" stroke="${darkStroke}" stroke-width="2" fill="none"/>
          </svg>
        `;
        break;
      case 'orange':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <circle cx="50" cy="54" r="28" fill="${color}" ${commonAttrs}/>
            <path d="M48 28 C48 22, 56 20, 62 22 C62 22, 56 28, 54 32" fill="${color}" stroke="${darkStroke}" stroke-width="2"/>
            <path d="M54 28 C60 26, 68 28, 72 30" stroke="${darkStroke}" stroke-width="2" fill="none"/>
          </svg>
        `;
        break;
      case 'cat':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <path d="M30 30 L40 16 L50 30 Q70 30 78 38 Q88 48 86 62 Q84 78 70 84 Q50 92 32 84 Q18 78 16 62 Q14 46 24 36 Q26 34 30 30 Z"
              fill="${color}" ${commonAttrs}/>
            <circle cx="42" cy="56" r="2.8" fill="${contrastColor(color)}"/>
            <circle cx="62" cy="56" r="2.8" fill="${contrastColor(color)}"/>
            <path d="M40 68 Q50 72 60 68" stroke="${contrastColor(color)}" stroke-width="2" fill="none" stroke-linecap="round" opacity=".7"/>
          </svg>
        `;
        break;
      case 'cloud':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <g fill="${color}" stroke="${darkStroke}" stroke-width="2">
              <ellipse cx="40" cy="60" rx="24" ry="16"/>
              <ellipse cx="58" cy="58" rx="20" ry="14"/>
              <ellipse cx="52" cy="50" rx="18" ry="14"/>
            </g>
          </svg>
        `;
        break;
      case 'bear':
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <circle cx="32" cy="28" r="8" fill="${color}" ${commonAttrs}/>
            <circle cx="68" cy="28" r="8" fill="${color}" ${commonAttrs}/>
            <circle cx="50" cy="52" r="28" fill="${color}" ${commonAttrs}/>
            <ellipse cx="50" cy="60" rx="10" ry="8" fill="#fff" opacity=".6"/>
            <circle cx="42" cy="50" r="3" fill="${contrastColor(color)}"/>
            <circle cx="58" cy="50" r="3" fill"${contrastColor(color)}"/>
          </svg>
        `;
        break;
      default:
        svg = `
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <circle cx="50" cy="50" r="32" fill="${color}" ${commonAttrs}/>
          </svg>
        `;
    }
    iconArea.innerHTML = svg;
    iconArea.firstElementChild && (iconArea.firstElementChild.style.transition = 'transform .25s ease');
  }

  function sample(arr, n){
    const copy = arr.slice();
    for(let i=copy.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy.slice(0, n);
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function newRound(){
    const pool = colors.filter(c => c.id !== lastId);
    current = pool[Math.floor(Math.random()*pool.length)];
    lastId = current.id;

    // choose 3 others for options
    const others = shuffle(colors.filter(c=>c.id!==current.id)).slice(0,3);
    roundOptions = shuffle([current, ...others]);

    renderIcon(current.shape, current.hex);
    renderOptions();
    setTimeout(()=>speak(current.es), 120);
  }

  function renderOptions(){
    optionsEl.innerHTML = '';
    roundOptions.forEach((c, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.setAttribute('data-id', c.id);
      btn.setAttribute('data-idx', idx+1);
      btn.setAttribute('aria-label', c.es);
      btn.style.background = c.hex.toLowerCase()==='#ffffff'
        ? '#ffffff'
        : c.hex;
      btn.style.color = c.hex.toLowerCase()==='#ffffff' ? '#333' : contrastColor(c.hex);
      btn.style.border = c.hex.toLowerCase()==='#ffffff' ? '2px solid #d9d9d9' : 'none';
      btn.style.filter = 'saturate(1.05) brightness(1.0)';
      btn.innerHTML = `<span class="swatch" style="background:${c.hex}; border-color:${c.hex.toLowerCase()==='#ffffff' ? '#d9d9d9' : 'rgba(0,0,0,.1)'}"></span> <span style="text-transform:capitalize">${c.es}</span>
        <span class="sr-only"> tecla ${idx+1}</span>`;
      btn.addEventListener('click', ()=> choose(c.id, btn));
      btn.addEventListener('pointerdown', ()=> btn.setPointerCapture && btn.setPointerCapture);
      optionsEl.appendChild(btn);
    });
  }

  function disableOptions(disabled=true){
    [...optionsEl.children].forEach(b => b.disabled = disabled);
  }

  function choose(id, btn){
    if(!current) return;
    if(id === current.id){
      animateIcon();
      btn.classList.add('good');
      award();
      celebrate();
      successSound();
      disableOptions(true);
      setTimeout(()=> newRound(), 700);
    }else{
      btn.classList.add('bad');
      setTimeout(()=>btn.classList.remove('bad'), 350);
      errorSound();
      vibrate(80);
      toastMsg('Int√©ntalo otra vez');
    }
  }

  function animateIcon(){
    const el = iconArea.firstElementChild;
    if(!el) return;
    el.style.transform = 'scale(1.05) rotate(-2deg)';
    setTimeout(()=> el.style.transform = 'scale(1) rotate(0deg)', 240);
  }

  function award(){
    score++;
    scoreVal.textContent = score;
    if(score>0 && score%5===0){
      toastMsg('¬°Excelente! ‚≠ê');
    }else{
      toastMsg('¬°Muy bien!');
    }
  }

  function celebrate(){
    const rect = iconArea.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;
    const colorsBurst = ['#ff3d71','#ffd166','#06d6a0','#118ab2','#8338ec','#ff006e','#ffd54f','#64dd17'];
    for(let i=0;i<18;i++){
      const p = document.createElement('div');
      p.className='particle';
      const col = colorsBurst[i % colorsBurst.length];
      p.style.background = col;
      const angle = Math.random()*Math.PI*2;
      const dist = 80 + Math.random()*120;
      const tx = Math.cos(angle)*dist + 'px';
      const ty = Math.sin(angle)*dist + 'px';
      p.style.setProperty('--tx', tx);
      p.style.setProperty('--ty', ty);
      p.style.left = cx+'px';
      p.style.top = cy+'px';
      cele.appendChild(p);
      setTimeout(()=>p.remove(), 800);
    }
  }

  function toastMsg(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toast.classList.remove('show'), 900);
  }

  function replay(){
    if(current) speak(current.es);
  }

  speakBtn.addEventListener('click', ()=>{ initAudio(); replay(); });

  muteBtn.addEventListener('click', ()=>{
    muted = !muted;
    muteBtn.setAttribute('aria-pressed', String(muted));
    muteBtn.textContent = muted ? 'üîá Silencio' : 'üîä Sonido';
    muteBtn.classList.toggle('muted', muted);
  });

  helpBtn.addEventListener('click', ()=>{
    document.getElementById('startOverlay').style.display='grid';
  });

  startBtn.addEventListener('click', ()=>{
    initAudio();
    if('speechSynthesis' in window){
      pickVoice();
      speechSynthesis.onvoiceschanged = ()=> pickVoice();
    }
    startOverlay.style.display='none';
    setTimeout(()=>newRound(), 100);
  });

  document.addEventListener('keydown', (e)=>{
    if(document.getElementById('startOverlay').style.display !== 'none'){
      if(e.key === 'Enter' || e.code === 'Space'){
        startBtn.click();
        e.preventDefault();
      }
      return;
    }
    const k = e.key;
    if(k === ' ' || e.code === 'Space'){
      e.preventDefault();
      replay();
      return;
    }
    if(['1','2','3','4'].includes(k)){
      const idx = parseInt(k,10);
      const btn = optionsEl.querySelector(`.opt[data-idx="${idx}"]`) || optionsEl.children[idx-1];
      if(btn){ btn.click(); }
    }
  });

  // Auto focus improvements for accessibility
  optionsEl.addEventListener('click', (e)=>{
    const t = e.target.closest('.opt');
    if(t) t.blur();
  });

  // Start muted if user chooses later; initially sound on but needs click to init.
  // Preload voices list
  if('speechSynthesis' in window){
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = ()=> pickVoice();
  }
})();
</script>
</body>
</html>