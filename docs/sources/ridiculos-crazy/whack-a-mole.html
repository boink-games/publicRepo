<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Whack-a-Mole - Friendly Tap Game</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root{
      --sky-top: #87CEEB;
      --sky-bottom: #d1f1ff;
      --hill-back: #8bc34a;
      --hill-front: #4caf50;
      --text:#1b2a2f;
      --accent:#ffb703;
      --panel:#ffffffd9;
      --shadow:0 8px 20px rgba(0,0,0,.15);
      --hole: clamp(80px, 24vw, 140px);
      --mole: calc(var(--hole) * .7);
      --radius: 18px;
      --gap: clamp(10px, 3vw, 20px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background: linear-gradient(180deg, var(--sky-top), var(--sky-bottom));
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .farm-background{
      position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index: -1;
    }

    .earth{
      position: absolute;
      bottom: 0; left:0; right:0;
      height: 50px;
      background: #8b5a2b;
    }
    .grass{
      position: absolute;
      bottom: 45px; left:0; right:0;
      height: 25px;
      background: #66bb6a;
    }

    .flower {
      position: absolute;
      bottom: 55px;
      left: var(--x-pos);
      font-size: var(--size);
      transform-origin: bottom center;
      animation: sway 4s ease-in-out infinite;
      animation-delay: var(--delay);
    }
    @keyframes sway {
      0%, 100% { transform: rotate(5deg); }
      50% { transform: rotate(-10deg); }
    }

    .butterfly {
      position: absolute;
      top: var(--y-start);
      left: -50px;
      font-size: var(--size);
      animation: fly-across linear infinite;
      animation-duration: var(--duration);
      animation-delay: var(--delay);
    }
    @keyframes fly-across {
      0% {
        transform: translateX(0) translateY(0) rotate(0deg);
      }
      25% {
        transform: translateX(30vw) translateY(-60px) rotate(5deg);
      }
      50% {
        transform: translateX(60vw) translateY(0px) rotate(-5deg);
      }
      75% {
        transform: translateX(90vw) translateY(-40px) rotate(10deg);
      }
      100% {
        transform: translateX(120vw) translateY(20px) rotate(0deg);
      }
    }

    .bird {
      position: absolute;
      top: var(--y-start);
      left: -50px;
      font-size: var(--size);
      animation: fly-bird linear infinite;
      animation-duration: var(--duration);
      animation-delay: var(--delay);
    }
    @keyframes fly-bird {
      from { transform: translateX(-50px); }
      to { transform: translateX(110vw); }
    }

    .wrap{
      position:relative;
      width:min(92vw, 560px);
      margin:auto;
      z-index:2;
      padding-top: 90px; /* Space for fixed header */
    }

    .header{
      position:fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      width: min(92vw, 560px);
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(220, 240, 255, 0.7), rgba(200, 230, 255, 0.6)); /* Light sky-blue gradient */
      padding: 10px;
      border-radius: var(--radius);
      box-shadow: 0 6px 18px rgba(0,0,0,0.15); /* Enhanced shadow for subtle lift */
      /* border: 1px solid rgba(255, 255, 255, 0.8); Removed for subtlety */
      backdrop-filter: blur(8px); /* Slightly more blur */
      z-index: 10;
    }
    .header-row1{
      display:flex;
      justify-content:center;
      margin-bottom: 8px;
    }
    .header-row2{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.3px;
      font-size: clamp(18px, 4.4vw, 26px); /* Keep original size for the .title container */
    }
    .game-title {
      font-family: 'Fredoka One', cursive;
      font-size: clamp(32px, 6vw, 48px); /* Larger font size */
      color: #e74c3c; /* A more intense red color */
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      line-height: 1;
    }
    .title .emoji{ font-size: 1.2em }
    .scoreboard{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px; background:#fff; box-shadow: inset 0 -2px 0 rgba(0,0,0,.06);
      font-weight:700;
      font-size: clamp(14px, 3.8vw, 18px);
      min-width: 90px; justify-content:center;
    }
    .controls{
      display:flex; gap:8px;
    }
    .btn{
      border:0; border-radius:12px; background:#fff;
      box-shadow: var(--shadow);
      font-size: clamp(18px, 5.5vw, 22px);
      padding: 10px 12px;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      transition: transform .06s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(.96) }
    .btn[aria-pressed="true"]{ background:#ffe8a6 }
    .btn .label{ margin-left:8px; font-weight:700; font-size:.9em }

    .game-instructions {
      text-align: center;
      margin-top: 15px;
      padding: 0 10px;
      font-size: clamp(12px, 3.5vw, 16px);
      color: var(--text);
      opacity: 0.8;
    }
    .game-instructions p {
      margin: 5px 0;
      line-height: 1.4;
    }
    .game-instructions .hint {
      font-size: clamp(11px, 3vw, 14px);
      opacity: 0.7;
    }

    .grid{
      margin-top: -20px; /* Moved even higher */
      display:grid;
      grid-template-columns: repeat(3, var(--hole));
      gap: var(--gap);
      justify-content:center;
      padding-bottom: 2vmin;
    }

    .hole{
      position:relative;
      width: var(--hole);
      height: var(--hole);
      border-radius:50%;
      background: radial-gradient(circle at 50% 45%, #6d5236 0 25%, #5a442c 26% 60%, #4a3925 61% 100%);
      box-shadow: inset 0 6px 12px rgba(0,0,0,.35), 0 8px 16px rgba(0,0,0,.15);
      overflow:hidden;
      isolation:isolate;
    }
    /* Dirt rim */
    .hole::after{
      content:"";
      position:absolute; left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: 88%; height: 46%;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0) 70%);
      border-radius: 50%;
      z-index:1;
      pointer-events:none;
    }

    .mole{
      position:absolute;
      left:50%;
      bottom:-68%;
      transform: translateX(-50%) translateY(0);
      width: var(--mole);
      height: var(--mole);
      border:none;
      border-radius: 50%;
      outline: none;
      background: radial-gradient(circle at 50% 35%, #ffe7c6 0 55%, #f5c08f 56% 100%);
      box-shadow: 0 6px 0 #b57548, 0 12px 18px rgba(0,0,0,.2);
      z-index:2;
      display:flex; align-items:center; justify-content:center;
      font-size: calc(var(--mole) * .6);
      line-height:1;
      cursor:pointer;
      will-change: transform, bottom;
      transition: transform .28s cubic-bezier(.2,.9,.25,1.2), box-shadow .2s ease;
      user-select:none;
    }
    .mole .face{ transform: translateY(-6%); }
    .mole.up{
      bottom:-6%;
      transform: translateX(-50%) translateY(0);
    }
    @media (prefers-reduced-motion: reduce){
      .mole{ transition:none }
    }

    /* Tap feedback */
    .mole.hit{
      transform: translateX(-50%) translateY(6%) scale(.9) rotate(-8deg);
      box-shadow: 0 2px 0 #b57548, 0 6px 12px rgba(0,0,0,.2);
    }

    /* Floating +1 badge */
    .pop{
      position:absolute; left:50%; top:20%;
      transform: translateX(-50%);
      background:#fff; color:#2a2a2a; border-radius:999px; padding:4px 8px;
      font-weight:900; font-size: clamp(12px, 3.5vw, 16px);
      box-shadow: var(--shadow);
      animation: rise .7s ease-out forwards;
      z-index:3;
      pointer-events:none;
    }
    @keyframes rise{
      from{ opacity:0; transform: translate(-50%, 10px) scale(.8) }
      30%{ opacity:1 }
      to{ opacity:0; transform: translate(-50%, -30px) scale(1) }
    }

    /* Sparkles */
    .sparkle{
      position:absolute; font-size: clamp(14px, 4vw, 18px); pointer-events:none; z-index:3;
      animation: burst .6s ease-out forwards;
    }
    @keyframes burst{
      from{ opacity:1; transform: translate(0,0) scale(1) rotate(0) }
      to{ opacity:0; transform: translate(var(--dx), var(--dy)) scale(1.2) rotate(35deg) }
    }

    /* Overlay for first start */
    .overlay{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.6));
      z-index:5;
      padding: 24px;
    }
    .card{
      width:min(92vw, 520px);
      background:#fff;
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 20px;
      text-align:center;
    }
    .card h2{
      margin:10px 0 6px; font-size: clamp(20px, 5.5vw, 28px)
    }
    .card p{ margin:6px 0 14px; font-size: clamp(14px, 4vw, 18px) }
    .big-btn{
      display:inline-flex; align-items:center; gap:10px;
      background:#ffcf66; border:none; border-radius:14px;
      padding: 12px 18px; font-weight:900; font-size: clamp(16px, 5vw, 20px);
      box-shadow: var(--shadow); cursor:pointer;
    }
    .big-btn:active{ transform: scale(.98) }

    /* Footer hint */
    .hint{ margin-top: 8px; font-size: clamp(12px, 3.5vw, 14px); opacity:.8 }

    /* Accessibility focus */
    .mole:focus-visible, .btn:focus-visible, .big-btn:focus-visible{
      outline: 3px solid #3a86ff; outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="farm-background" aria-hidden="true">
    <div class="earth"></div>
    <div class="grass"></div>
    <div id="flowers-container"></div>
    <div id="butterflies-container"></div>
    <div id="birds-container"></div>
  </div>

  <div class="wrap">
    <div class="header">
      <div class="header-row1">
        <div class="title" aria-live="polite">
          <span class="emoji" role="img" aria-label="Mole">üêπ</span>
          <span class="game-title">Whack a Mole!</span>
        </div>
      </div>
      <div class="header-row2">
        <div class="scoreboard">
          <div class="pill" id="scorePill" aria-label="Score">
            ‚≠ê Score: <span id="score">0</span>
          </div>
          <div class="pill" id="bestPill" aria-label="Best">
            üèÜ Best: <span id="best">0</span>
          </div>
        </div>
        <div class="controls">
          <button id="playBtn" class="btn" aria-pressed="false" title="Play or Pause">
            <span class="icon" id="playIcon">‚ñ∂Ô∏è</span>
          </button>
          <button id="muteBtn" class="btn" aria-pressed="false" title="Sound on/off">
            <span class="icon" id="muteIcon">üîä</span>
          </button>
        </div>
      </div>
    </div>

    <div class="grid" id="grid" aria-label="Mole holes" role="group"></div>

    <div class="game-instructions">
      <p>When the cute face pops up, tap it to get a star point.</p>
      <p class="hint">Tip: Works with fingers or mouse. Have fun!</p>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="card">
      <div style="font-size:64px" aria-hidden="true">üêπ‚ú®</div>
      <h2>Tap the popping friend!</h2>
      <p>When the cute face pops up, tap it to get a star point.</p>
      <button class="big-btn" id="startGame">
        ‚ñ∂Ô∏è Start
      </button>
      <div class="hint">Tip: Works with fingers or mouse. Have fun!</div>
    </div>
  </div>

  <script>
    // Elements
    const grid = document.getElementById('grid');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const muteBtn = document.getElementById('muteBtn');
    const muteIcon = document.getElementById('muteIcon');
    const overlay = document.getElementById('overlay');
    const startGameBtn = document.getElementById('startGame');

    // State
    let running = false;
    let score = 0;
    let best = Number(localStorage.getItem('mole_best') || 0);
    bestEl.textContent = best;
    let muted = JSON.parse(localStorage.getItem('mole_muted') || 'false');
    updateMuteUI();

    const HOLES = 9;
    let currentIndex = -1;
    let currentMole = null;
    let hideTO = null;
    let nextTO = null;

    // Cute faces to cycle
    const FACES = ['üêπ','üê∞','üê≠','üê±','üêµ'];

    // Build grid
    for (let i = 0; i < HOLES; i++) {
      const hole = document.createElement('div');
      hole.className = 'hole';
      hole.setAttribute('role','presentation');

      const mole = document.createElement('button');
      mole.className = 'mole';
      mole.type = 'button';
      mole.setAttribute('aria-label','Mole');
      mole.setAttribute('tabindex','0');

      const face = document.createElement('div');
      face.className = 'face';
      face.textContent = 'üêπ';
      mole.appendChild(face);

      hole.appendChild(mole);
      grid.appendChild(hole);
    }

    // Input: tap/click using pointer events
    grid.addEventListener('pointerdown', onTap, {passive:true});
    grid.addEventListener('click', onTap, {passive:true}); // fallback

    function onTap(e){
      const target = e.target.closest('.mole');
      if (!target) return;
      if (target !== currentMole) return;
      if (!target.classList.contains('up')) return;
      if (target.dataset.hit === '1') return; // already hit this pop

      target.dataset.hit = '1';
      target.classList.add('hit');
      addScore(1);
      haptic(40);
      beep(660, 0.06);

      // Floating +1
      showPlusOne(target);

      // Sparkles
      sparkleBurst(target);

      // Hide mole quickly after hit
      clearTimeout(hideTO);
      hideTO = setTimeout(hideMole, 220);
    }

    function showPlusOne(target){
      const badge = document.createElement('div');
      badge.className = 'pop';
      badge.textContent = '+1';
      target.parentElement.appendChild(badge);
      setTimeout(() => badge.remove(), 700);
    }

    function sparkleBurst(target){
      const hole = target.parentElement;
      const rect = hole.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height*0.35;
      const emojis = ['‚ú®','‚≠ê','üåü'];
      for (let i=0;i<6;i++){
        const s = document.createElement('div');
        s.className = 'sparkle';
        s.textContent = emojis[i%emojis.length];
        const angle = (i/6) * Math.PI*2;
        const dx = Math.cos(angle) * (rect.width*0.25);
        const dy = Math.sin(angle) * (rect.height*0.18);
        s.style.left = (cx) + 'px';
        s.style.top = (cy) + 'px';
        s.style.setProperty('--dx', dx+'px');
        s.style.setProperty('--dy', dy+'px');
        hole.appendChild(s);
        setTimeout(()=>s.remove(), 650);
      }
    }

    // Game loop
    function start(){
      if (running) return;
      running = true;
      playBtn.setAttribute('aria-pressed','true');
      playIcon.textContent = '‚è∏Ô∏è';
      overlay.style.display = 'none';
      scheduleNext(400);
    }
    function pause(){
      running = false;
      playBtn.setAttribute('aria-pressed','false');
      playIcon.textContent = '‚ñ∂Ô∏è';
      clearTimeout(nextTO);
      clearTimeout(hideTO);
      hideMole(true);
    }
    function togglePlay(){
      running ? pause() : start();
    }
    playBtn.addEventListener('click', togglePlay);
    startGameBtn.addEventListener('click', start);

    function scheduleNext(delay){
      clearTimeout(nextTO);
      nextTO = setTimeout(showMole, delay ?? rand(700, 1100));
    }

    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min }

    function pickIndex(){
      let idx;
      do { idx = Math.floor(Math.random()*HOLES) } while (idx === currentIndex);
      currentIndex = idx;
      return idx;
    }

    function showMole(){
      if (!running) return;
      const holes = grid.querySelectorAll('.hole');
      const idx = pickIndex();
      const hole = holes[idx];
      const mole = hole.querySelector('.mole');
      currentMole = mole;

      mole.classList.remove('hit');
      mole.dataset.hit = '0';
      mole.querySelector('.face').textContent = FACES[rand(0, FACES.length-1)];
      mole.classList.add('up');

      // Time the mole stays up, a bit generous for small
      const upTime = rand(900, 1300);
      clearTimeout(hideTO);
      hideTO = setTimeout(hideMole, upTime);
    }

    function hideMole(immediate=false){
      if (currentMole){
        if (immediate){
          currentMole.classList.remove('up','hit');
        } else {
          currentMole.classList.remove('up','hit');
        }
      }
      currentMole = null;
      if (running) scheduleNext(rand(650, 1100));
    }

    function addScore(n){
      score += n;
      scoreEl.textContent = score;
      if (score > best){
        best = score;
        bestEl.textContent = best;
        localStorage.setItem('mole_best', String(best));
      }
    }

    // Audio feedback with WebAudio
    let audioCtx = null;
    function ensureAudio(){
      if (!audioCtx){
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          audioCtx = null;
        }
      }
    }
    function beep(freq=660, dur=0.07){
      if (muted) return;
      ensureAudio();
      if (!audioCtx) return;
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, t);
      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(0.08, t + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(t);
      osc.stop(t + dur + 0.02);
    }

    function haptic(ms=30){
      if (navigator.vibrate) navigator.vibrate(ms);
    }

    function updateMuteUI(){
      muteBtn.setAttribute('aria-pressed', String(muted));
      muteIcon.textContent = muted ? 'üîá' : 'üîä';
    }
    muteBtn.addEventListener('click', ()=>{
      muted = !muted;
      localStorage.setItem('mole_muted', JSON.stringify(muted));
      updateMuteUI();
      haptic(10);
    });

    // Reset score when starting a fresh run via overlay
    startGameBtn.addEventListener('click', ()=>{
      score = 0;
      scoreEl.textContent = '0';
    });

    // Pause when tab hidden, resume when visible (gentle)
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden) {
        if (running) pause();
      }
    });

    // Keyboard accessibility: Space/Enter hits focused mole
    grid.addEventListener('keydown', (e)=>{
      if ((e.key === ' ' || e.key === 'Enter') && document.activeElement.classList.contains('mole')){
        onTap({target: document.activeElement});
        e.preventDefault();
      }
    });

    // Start paused with overlay visible; user can also press play button

    // Generate decorative elements
    function createDecorations(){
      const flowersContainer = document.getElementById('flowers-container');
      const butterfliesContainer = document.getElementById('butterflies-container');
      const birdsContainer = document.getElementById('birds-container');
      if (!flowersContainer || !butterfliesContainer || !birdsContainer) return;

      // Flowers
      const flowerEmojis = ['üå∏', 'üåº', 'üå∑', 'üåª', 'üåπ'];
      for(let i=0; i<10; i++){
        const f = document.createElement('div');
        f.className = 'flower';
        f.textContent = flowerEmojis[i % flowerEmojis.length];
        f.style.setProperty('--size', (20 + Math.random() * 15) + 'px');
        f.style.setProperty('--x-pos', (5 + Math.random() * 90) + 'vw');
        f.style.setProperty('--delay', (Math.random() * 4) + 's');
        flowersContainer.appendChild(f);
      }

      // Butterflies
      const butterflyEmojis = ['ü¶ã', 'üêõ', 'üêû'];
      for(let i=0; i<5; i++){
        const b = document.createElement('div');
        b.className = 'butterfly';
        b.textContent = butterflyEmojis[i % butterflyEmojis.length];
        b.style.setProperty('--size', (20 + Math.random() * 10) + 'px');
        b.style.setProperty('--y-start', (10 + Math.random() * 40) + 'vh');
        b.style.setProperty('--duration', (8 + Math.random() * 8) + 's');
        b.style.setProperty('--delay', (Math.random() * 10) + 's');
        butterfliesContainer.appendChild(b);
      }

      // Birds
      const birdEmojis = ['üê¶', 'üïäÔ∏è'];
      for(let i=0; i<3; i++){
        const bird = document.createElement('div');
        bird.className = 'bird';
        bird.textContent = birdEmojis[i % birdEmojis.length];
        bird.style.setProperty('--size', (25 + Math.random() * 15) + 'px');
        bird.style.setProperty('--y-start', (5 + Math.random() * 20) + 'vh');
        bird.style.setProperty('--duration', (10 + Math.random() * 10) + 's');
        bird.style.setProperty('--delay', (Math.random() * 12) + 's');
        birdsContainer.appendChild(bird);
      }
    }
    createDecorations();
  </script>
</body>
</html>
