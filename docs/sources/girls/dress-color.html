<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Dress Match</title>
  <meta name="theme-color" content="#83c5ff">
  <style>
    :root{
      --bg1:#b3e5ff;
      --bg2:#f5e4ff;
      --panel:#ffffffee;
      --ink:#0f172a;
      --soft:#e6eefb;
      --accent:#6ee7b7;
      --accent2:#60a5fa;
      --stroke:#d6def7;
      --shadow:0 10px 28px rgba(31,41,55,.18);
    }
    *{box-sizing:border-box;touch-action:manipulation}
    html,body{height:100%;margin:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji",sans-serif;
      color:var(--ink);
      background:linear-gradient(160deg,var(--bg1),var(--bg2)) fixed;
      overflow:hidden;
    }
    .wrap{
      height:100dvh;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      display:grid;
      grid-template-rows:auto auto auto auto;
      align-content:center;
      justify-items:center;
      gap:10px;
    }
    .title{
      font-weight:800;letter-spacing:.5px;color:#0b194f;text-shadow:0 2px 0 #ffffff80;
      font-size:clamp(16px,3.4vw,26px);
    }
    .layout{
      display:grid;
      grid-template-columns:1fr;
      grid-template-rows:auto auto;
      align-items:center;
      gap:8px;
      width:100%;
      max-width:920px;
    }
    .stage{
      width:min(360px,84vw);
      aspect-ratio:3/4;
      background:radial-gradient(120% 140% at 50% 10%, #fff 0%, var(--soft) 65%, #eaf2ff 100%);
      border:2px solid var(--stroke);
      border-radius:20px;
      position:relative;
      overflow:hidden;
      box-shadow:var(--shadow);
      justify-self:center;
    }
    canvas{width:100%;height:100%;display:block}
    .fx{position:absolute;inset:0;pointer-events:none}
    .bubbles{position:absolute;inset:0;pointer-events:none;opacity:.28}
    .b1,.b2,.b3{
      position:absolute;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff, #c8e3ff);
      animation:float 8s ease-in-out infinite
    }
    .b1{width:90px;height:90px;left:8%;top:70%;animation-delay:-2s}
    .b2{width:120px;height:120px;left:74%;top:10%;animation-delay:-4s}
    .b3{width:70px;height:70px;left:60%;top:72%;animation-delay:-1s}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

    .ui{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      width:min(520px,94vw);
      justify-self:center;
    }
    .hint{font-size:12px;color:#24466b99;text-align:center}
    .toolbar,.palette,.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .tool{
      background:#fff;border:2px solid var(--stroke);border-radius:12px;padding:6px 8px;min-width:58px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
      box-shadow:0 6px 14px rgba(0,0,0,.06);cursor:pointer;user-select:none;font-weight:700;color:#243b6b
    }
    .tool .ico{font-size:20px;line-height:1}
    .tool .lab{font-size:11px;opacity:.9}
    .tool:active{transform:scale(.98)}
    .tool.active{outline:3px solid var(--accent2);box-shadow:0 0 0 6px #60a5fa2b}
    .palette{
      background:#ffffffb5;border:2px solid var(--stroke);border-radius:12px;padding:8px;box-shadow:0 6px 14px rgba(0,0,0,.04);
      display:grid;grid-template-columns:repeat(auto-fit,minmax(30px,1fr));gap:8px
    }
    .swatch{
      width:34px;height:34px;border-radius:10px;border:3px solid #ffffffcc;box-shadow:0 5px 10px #0000001b;
      cursor:pointer;transition:transform .08s ease, box-shadow .2s ease
    }
    .swatch:active{transform:scale(.96)}
    .controls{align-items:center}
    .btn{
      border:0;border-radius:12px;padding:9px 12px;font-size:14px;font-weight:800;cursor:pointer;color:#073b2d;
      background:linear-gradient(180deg,#a7f3d0,#6ee7b7);box-shadow:0 8px 18px #064e3b24;display:inline-flex;align-items:center;gap:6px
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:linear-gradient(180deg,#bfdbfe,#93c5fd);color:#0b2b66}
    .btn.ghost{background:#ffffff;color:#385389;border:2px solid var(--stroke)}
    .msg{
      min-width:160px;min-height:20px;text-align:center;font-weight:900;font-size:16px;color:#0b2b66;
      text-shadow:0 2px 12px #ffffff;letter-spacing:.3px
    }

    /* Sparkles */
    .sparkle{
      position:absolute;font-size:20px;animation:pop 900ms ease-out forwards;filter:drop-shadow(0 2px 2px #0000001a)
    }
    @keyframes pop{
      0%{opacity:0;transform:translate(var(--x),var(--y)) scale(.4) rotate(0deg)}
      40%{opacity:1}
      100%{opacity:0;transform:translate(calc(var(--x) + var(--dx)),calc(var(--y) + var(--dy))) scale(1.2) rotate(18deg)}
    }

    button:focus-visible,.swatch:focus-visible{outline:3px solid #22d3ee;outline-offset:3px;border-radius:12px}

    @media (min-width:880px){
      .layout{
        grid-template-columns:min(380px,40vw) 1fr;
        grid-template-rows:auto;
        align-items:start;
      }
      .ui{align-self:center}
      .stage{width:min(380px,40vw)}
    }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Dress Match game">
    <div class="title" aria-hidden="true">Dress Match</div>

    <div class="layout">
      <div class="stage" id="stage" aria-label="Avatar">
        <canvas id="avatar" width="340" height="460"></canvas>
        <div class="bubbles"><div class="b1"></div><div class="b2"></div><div class="b3"></div></div>
        <div class="fx" id="fx" aria-hidden="true"></div>
      </div>

      <div class="ui">
        <div class="hint">Tap a picture, then tap a color</div>
        <div class="toolbar" id="tools" role="toolbar" aria-label="Parts"></div>
        <div class="palette" id="palette" aria-label="Colors"></div>
        <div class="controls">
          <button class="btn" id="check" aria-label="Check match"><span>âœ¨</span><span>Check</span></button>
          <button class="btn secondary" id="random" aria-label="Random outfit"><span>ðŸŽ²</span><span>Random</span></button>
          <button class="btn ghost" id="reset" aria-label="Reset colors"><span>ðŸ§¼</span><span>Reset</span></button>
          <span class="msg" id="msg" aria-live="polite"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    (()=>{'use strict';

      // Speech (friendly for kids)
      function speak(text){
        try{
          if(!('speechSynthesis' in window)) return;
          speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(String(text));
          u.lang = 'en-US'; u.rate = .95; u.pitch = 1.1;
          speechSynthesis.speak(u);
        }catch(_){}
      }
      function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(_){ } }

      // Colors and parts
      const COLORS=[
        '#111827','#374151','#6b7280','#a78bfa','#ef4444','#f59e0b',
        '#22c55e','#60a5fa','#ec4899','#fde047','#10b981','#93c5fd','#c084fc','#fb7185'
      ];
      const PARTS=[
        {key:'HAIR',label:'Hair',icon:'ðŸ’‡'},
        {key:'TOP',label:'Top',icon:'ðŸ‘š'},
        {key:'BOTTOM',label:'Skirt',icon:'ðŸ‘—'},
        {key:'SHOES',label:'Shoes',icon:'ðŸ‘Ÿ'},
        {key:'BAG',label:'Bag',icon:'ðŸ‘œ'},
        {key:'NECKLACE',label:'Necklace',icon:'ðŸ“¿'}
      ];
      const NICE=[ ['#a78bfa','#60a5fa'], ['#ec4899','#fde047'], ['#22c55e','#93c5fd'], ['#ef4444','#f59e0b'] ];

      const tools = document.getElementById('tools');
      const pal = document.getElementById('palette');
      const msg = document.getElementById('msg');
      const fx = document.getElementById('fx');
      const stage = document.getElementById('stage');

      let active='TOP';
      const style={
        HAIR:'#331d10',
        TOP:'#a78bfa',
        BOTTOM:'#6b7280',
        SHOES:'#111827',
        BAG:'#374151',
        NECKLACE:'#fde047'
      };

      // Canvas and drawing
      const BASE_W=340, BASE_H=460;
      const cv = document.getElementById('avatar');
      const ctx = cv.getContext('2d');

      let scaleX=1, scaleY=1; // css->base mapping
      let t0 = performance.now();
      let paths = {}; // precise shapes for hit testing and drawing

      function resizeCanvas(){
        const rect = cv.getBoundingClientRect();
        const dpr = Math.min(window.devicePixelRatio||1, 2);
        cv.width = Math.round(rect.width * dpr);
        cv.height = Math.round(rect.height * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        scaleX = BASE_W / rect.width;
        scaleY = BASE_H / rect.height;
        drawAvatar(performance.now());
      }

      const SELECT_ORDER=['NECKLACE','BAG','HAIR','TOP','BOTTOM','SHOES']; // front to back

      // Color helpers
      const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
      function hexToRgb(hex){
        const v = hex.replace('#','');
        return [parseInt(v.slice(0,2),16),parseInt(v.slice(2,4),16),parseInt(v.slice(4,6),16)];
      }
      function rgbToHex([r,g,b]){
        const h=(n)=>n.toString(16).padStart(2,'0');
        return '#'+h(clamp(Math.round(r),0,255))+h(clamp(Math.round(g),0,255))+h(clamp(Math.round(b),0,255));
      }
      function shade(hex,percent){
        const [r,g,b]=hexToRgb(hex);
        const amt=percent*255;
        return rgbToHex([r+amt,g+amt,b+amt]);
      }
      function gradient(color, y0, y1){
        const g=ctx.createLinearGradient(0,y0,0,y1);
        g.addColorStop(0, shade(color, .18));
        g.addColorStop(.5, color);
        g.addColorStop(1, shade(color, -.14));
        return g;
      }
      function strokeColor(color){ return shade(color, -.35); }

      // Rounded rect helper
      function roundRectPath(x,y,w,h,r){
        const p=new Path2D();
        r=Math.min(r, w/2, h/2);
        p.moveTo(x+r,y);
        p.arcTo(x+w,y,x+w,y+h,r);
        p.arcTo(x+w,y+h,x,y+h,r);
        p.arcTo(x,y+h,x,y,r);
        p.arcTo(x,y,x+w,y,r);
        p.closePath();
        return p;
      }

      // Build more realistic shapes
      function buildPaths(){
        const P={};

        // Hair: fluffy bob with bangs
        const hair=new Path2D();
        hair.moveTo(112,114);
        hair.bezierCurveTo(110,160,126,190,140,198);
        hair.bezierCurveTo(150,205,190,205,200,198);
        hair.bezierCurveTo(214,190,230,158,228,114);
        hair.bezierCurveTo(220,92,198,80,170,82);
        hair.bezierCurveTo(142,80,120,92,112,114);
        // bangs overlap
        const bangs=new Path2D();
        bangs.moveTo(132,120);
        bangs.quadraticCurveTo(150,100,170,108);
        bangs.quadraticCurveTo(188,100,206,120);
        // Merge hair shapes for hit
        const HAIR={fill:hair, overlay:bangs};

        // Top: t-shirt with short sleeves
        const top=new Path2D();
        // torso
        top.addPath(roundRectPath(132,206,76,70,14));
        // left sleeve
        top.moveTo(132,210);
        top.quadraticCurveTo(118,220,118,236);
        top.quadraticCurveTo(126,244,136,238);
        top.lineTo(132,210);
        // right sleeve
        top.moveTo(208,210);
        top.quadraticCurveTo(222,220,222,236);
        top.quadraticCurveTo(214,244,204,238);
        top.lineTo(208,210);

        // Bottom: pleated skirt
        const skirt=new Path2D();
        skirt.moveTo(132,276);
        skirt.quadraticCurveTo(170,270,208,276);
        skirt.lineTo(224,340);
        skirt.quadraticCurveTo(170,352,116,340);
        skirt.closePath();

        // Shoes: two rounded shoes
        const shoes=new Path2D();
        shoes.addPath(roundRectPath(130,384,44,16,8));
        shoes.addPath(roundRectPath(166,384,44,16,8));

        // Bag: rounded purse + crossbody strap
        const bagBody=roundRectPath(226,260,30,24,6);
        const strap=new Path2D();
        strap.moveTo(170,190);
        strap.quadraticCurveTo(208,220,241,262);

        // Necklace: arc stroke + hit ring
        const necklaceStroke=new Path2D();
        necklaceStroke.arc(170,186,16,Math.PI,0);
        const necklaceHit=new Path2D();
        necklaceHit.moveTo(154,186);
        necklaceHit.arc(170,186,20,Math.PI,0);
        necklaceHit.arc(170,186,12,0,Math.PI,true);
        necklaceHit.closePath();

        P.HAIR={fill:hair, overlay:bangs};
        P.TOP={fill:top};
        P.BOTTOM={fill:skirt};
        P.SHOES={fill:shoes};
        P.BAG={fill:bagBody, stroke:strap, strokeWidth:10};
        P.NECKLACE={stroke:necklaceStroke, strokeWidth:8, hit:necklaceHit};

        return P;
      }
      paths = buildPaths();

      // Drawing
      function drawAvatar(now){
        ctx.clearRect(0,0,cv.width,cv.height);

        const t = (now - t0);
        const bob = Math.sin(t/900)*1.2;

        ctx.save();
        const sx = cv.width / (window.devicePixelRatio||1) / BASE_W;
        const sy = cv.height / (window.devicePixelRatio||1) / BASE_H;
        ctx.scale(sx,sy);
        ctx.translate(0,bob);

        // subtle ground shadow
        ctx.fillStyle='rgba(0,0,0,0.06)';
        ctx.beginPath();
        ctx.ellipse(170,420,80,14,0,0,Math.PI*2);
        ctx.fill();

        // Hair (behind head)
        if(paths.HAIR?.fill){
          const c=style.HAIR;
          ctx.fillStyle=gradient(c,80,210);
          ctx.fill(paths.HAIR.fill);
        }

        // head + neck + simple face
        ctx.fillStyle='#f6d7b0';
        ctx.beginPath();
        ctx.arc(170,140,30,0,Math.PI*2);
        ctx.fill();
        ctx.fillRect(162,170,16,16);
        // ears
        ctx.beginPath();
        ctx.arc(140,140,6,0,Math.PI*2);
        ctx.arc(200,140,6,0,Math.PI*2);
        ctx.fill();
        // eyes
        ctx.fillStyle='#2b2b2b';
        ctx.beginPath();
        ctx.arc(158,138,2.8,0,Math.PI*2);
        ctx.arc(182,138,2.8,0,Math.PI*2);
        ctx.fill();
        // smile
        ctx.strokeStyle='#b06b5a';
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.arc(170,148,7,0,Math.PI);
        ctx.stroke();

        // Hair bangs overlay (on top of forehead)
        if(paths.HAIR?.overlay){
          const c=style.HAIR;
          ctx.fillStyle=gradient(c,100,150);
          ctx.globalAlpha=0.95;
          ctx.fill(paths.HAIR.overlay);
          ctx.globalAlpha=1;
        }

        // necklace beads
        {
          const cc=style.NECKLACE;
          // big arc shadow
          ctx.strokeStyle=shade(cc,-.35);
          ctx.lineWidth=4;
          ctx.globalAlpha=0.25;
          ctx.beginPath();
          ctx.arc(170,186,16,Math.PI,0);
          ctx.stroke();
          ctx.globalAlpha=1;

          // beads
          const R=16, cx=170, cy=186;
          const beads=11;
          for(let i=0;i<=beads;i++){
            const a=Math.PI + (i/beads)*Math.PI;
            const x=cx + Math.cos(a)*R;
            const y=cy + Math.sin(a)*R;
            ctx.fillStyle=(i===Math.floor(beads/2))?shade(cc,.15):cc;
            ctx.beginPath();
            ctx.arc(x,y,3.2,0,Math.PI*2);
            ctx.fill();
          }
          // little star pendant
          ctx.fillStyle=shade(cc,.1);
          const px=cx, py=cy+R+3;
          ctx.beginPath();
          for(let k=0;k<5;k++){
            const ang=-Math.PI/2 + k*(Math.PI*2/5);
            const x=px+Math.cos(ang)*4, y=py+Math.sin(ang)*4;
            ctx.lineTo(x,y);
            const ang2=ang+Math.PI/5;
            const x2=px+Math.cos(ang2)*2, y2=py+Math.sin(ang2)*2;
            ctx.lineTo(x2,y2);
          }
          ctx.closePath();
          ctx.fill();
        }

        // torso (t-shirt)
        {
          const c=style.TOP;
          ctx.fillStyle=gradient(c,206,276);
          ctx.fill(paths.TOP.fill);
          // seams
          ctx.strokeStyle=shade(c,-.25);
          ctx.lineWidth=1.2;
          ctx.setLineDash([3,3]);
          ctx.beginPath();
          ctx.moveTo(170,210); ctx.lineTo(170,276);
          ctx.stroke();
          ctx.setLineDash([]);
        }

        // bottom (pleated skirt)
        {
          const c=style.BOTTOM;
          ctx.fillStyle=gradient(c,270,345);
          ctx.fill(paths.BOTTOM.fill);
          // pleats
          ctx.strokeStyle=shade(c,-.25);
          ctx.globalAlpha=0.28;
          ctx.lineWidth=2;
          for(let i=1;i<=6;i++){
            const t=i/7;
            const x=132 + (208-132)*t;
            const xb=120 + (224-120)*t;
            ctx.beginPath();
            ctx.moveTo(x,278);
            ctx.lineTo(xb,338);
            ctx.stroke();
          }
          ctx.globalAlpha=1;
        }

        // legs
        ctx.fillStyle='#f6d7b0';
        ctx.fill(roundRectPath(146,340,18,44,6));
        ctx.fill(roundRectPath(176,340,18,44,6));

        // shoes with laces
        {
          const c=style.SHOES;
          ctx.fillStyle=gradient(c,382,402);
          ctx.fill(paths.SHOES.fill);
          ctx.strokeStyle=shade(c,-.35);
          ctx.lineWidth=1.4;
          // lace marks
          for(const off of [136,172]){
            ctx.beginPath();
            ctx.moveTo(off+8,392); ctx.lineTo(off+28,392);
            ctx.moveTo(off+8,395); ctx.lineTo(off+28,395);
            ctx.stroke();
          }
        }

        // bag with strap
        {
          const c=style.BAG;
          // strap
          ctx.strokeStyle=shade(c,-.2);
          ctx.lineWidth=6;
          ctx.lineCap='round';
          ctx.stroke(paths.BAG.stroke);
          // body
          ctx.fillStyle=gradient(c,260,290);
          ctx.fill(paths.BAG.fill);
          // clasp
          ctx.fillStyle=shade(c,.25);
          ctx.fill(roundRectPath(238,269,6,6,2));
        }

        // active glow
        if(paths[active]){
          ctx.save();
          ctx.shadowColor='rgba(96,165,250,.9)';
          ctx.shadowBlur=14;
          ctx.lineWidth=6;
          ctx.strokeStyle='#60a5fa';
          const p=paths[active];
          if(p.fill){
            ctx.stroke(p.fill);
          }else if(p.stroke){
            ctx.lineWidth=(p.strokeWidth||8)+2;
            ctx.stroke(p.stroke);
          }else if(p.hit){
            ctx.stroke(p.hit);
          }
          ctx.restore();
        }

        ctx.restore();
      }

      // Tools
      function renderTools(){
        tools.innerHTML='';
        PARTS.forEach(p=>{
          const b=document.createElement('button');
          b.className='tool'+(p.key===active?' active':'');
          b.setAttribute('role','button');
          b.setAttribute('aria-label',p.label);
          b.innerHTML=`<div class="ico">${p.icon}</div><div class="lab">${p.label}</div>`;
          b.addEventListener('pointerdown',()=>{
            active=p.key;
            renderTools();
            drawAvatar(performance.now());
            speak(p.label);
            vibrate(8);
          },{passive:true});
          tools.appendChild(b);
        });
      }

      // Palette
      function renderPalette(){
        pal.innerHTML='';
        COLORS.forEach(c=>{
          const d=document.createElement('button');
          d.className='swatch';
          d.style.background=c;
          d.setAttribute('aria-label',`Color ${c}`);
          d.addEventListener('pointerdown',()=>{
            style[active]=c;
            drawAvatar(performance.now());
            popSparklesRandom();
            vibrate(8);
          },{passive:true});
          pal.appendChild(d);
        });
      }

      // Hit testing on canvas (tap a part to select)
      function hit(key, xBase, yBase){
        const p=paths[key];
        if(!p) return false;
        if(p.hit && ctx.isPointInPath(p.hit, xBase, yBase)) return true;
        if(p.fill && ctx.isPointInPath(p.fill, xBase, yBase)) return true;
        if(p.stroke){
          const old=ctx.lineWidth;
          ctx.lineWidth=p.strokeWidth||10;
          const ok=ctx.isPointInStroke(p.stroke, xBase, yBase);
          ctx.lineWidth=old;
          if(ok) return true;
        }
        return false;
      }
      cv.addEventListener('pointerdown', (e)=>{
        const rect = cv.getBoundingClientRect();
        const xCss = e.clientX - rect.left;
        const yCss = e.clientY - rect.top;
        const xBase = xCss * scaleX;
        const yBase = yCss * scaleY;

        for(const key of SELECT_ORDER){
          if(hit(key,xBase,yBase)){
            active = key;
            renderTools();
            drawAvatar(performance.now());
            const label = PARTS.find(pp=>pp.key===key)?.label || key;
            speak(label);
            vibrate(10);
            return;
          }
        }
      }, {passive:true});

      // Utils
      function closeHex(a,b){
        const A=hexToRgb(a), B=hexToRgb(b);
        return Math.abs(A[0]-B[0])+Math.abs(A[1]-B[1])+Math.abs(A[2]-B[2])<60;
      }

      function checkMatch(){
        const t=style.TOP, b=style.BOTTOM;
        let ok=false;
        for(const pair of NICE){
          if((closeHex(t,pair[0])&&closeHex(b,pair[1])) || (closeHex(t,pair[1])&&closeHex(b,pair[0]))){
            ok=true; break;
          }
        }
        if(ok){
          msg.textContent='Yay! Lovely match! âœ¨';
          speak('Yay! Lovely match!');
          burstSparkles();
          vibrate([20,30,20]);
        }else{
          msg.textContent='Try another combo ðŸ˜Š';
          speak('Try another combo');
          vibrate(15);
        }
      }

      function randomOutfit(){
        const pick=()=>COLORS[Math.floor(Math.random()*COLORS.length)];
        style.TOP=pick();
        style.BOTTOM=pick();
        style.HAIR=pick();
        style.SHOES=pick();
        style.BAG=pick();
        style.NECKLACE=pick();
        drawAvatar(performance.now());
        popSparklesRandom();
      }

      function resetOutfit(){
        style.HAIR='#331d10';
        style.TOP='#a78bfa';
        style.BOTTOM='#6b7280';
        style.SHOES='#111827';
        style.BAG='#374151';
        style.NECKLACE='#fde047';
        msg.textContent='';
        drawAvatar(performance.now());
      }

      // Sparkles
      const EMOJI = ['âœ¨','ðŸŒŸ','ðŸ’–','ðŸ’«','ðŸŒˆ'];
      function sparkle(x,y,dx,dy){
        const s=document.createElement('span');
        s.className='sparkle';
        s.textContent=EMOJI[(Math.random()*EMOJI.length)|0];
        s.style.setProperty('--x', x+'px');
        s.style.setProperty('--y', y+'px');
        s.style.setProperty('--dx', dx+'px');
        s.style.setProperty('--dy', dy+'px');
        fx.appendChild(s);
        setTimeout(()=>s.remove(),900);
      }
      function burstSparkles(){
        const rect = stage.getBoundingClientRect();
        for(let i=0;i<18;i++){
          const x = rect.width*0.5 + (Math.random()*120-60);
          const y = rect.height*0.45 + (Math.random()*60-30);
          const dx = (Math.random()*140-70);
          const dy = (Math.random()*-120-30);
          sparkle(x,y,dx,dy);
        }
      }
      function popSparklesRandom(){
        const rect = stage.getBoundingClientRect();
        const x = Math.random()*rect.width*0.8 + rect.width*0.1;
        const y = Math.random()*rect.height*0.6 + rect.height*0.1;
        for(let i=0;i<5;i++){
          sparkle(x + Math.random()*20-10, y + Math.random()*20-10, Math.random()*40-20, Math.random()*-30-10);
        }
      }

      // Controls
      document.getElementById('check').addEventListener('click', checkMatch);
      document.getElementById('random').addEventListener('click', randomOutfit);
      document.getElementById('reset').addEventListener('click', resetOutfit);

      // Animation loop (gentle bob)
      let animId=null;
      function loop(now){
        drawAvatar(now);
        animId = requestAnimationFrame(loop);
      }

      // Init
      renderTools();
      renderPalette();
      resizeCanvas();
      new ResizeObserver(resizeCanvas).observe(stage);
      animId = requestAnimationFrame(loop);

      // Pause on hide
      document.addEventListener('visibilitychange',()=>{
        if(document.hidden){ if(animId) cancelAnimationFrame(animId); }
        else { t0=performance.now(); animId=requestAnimationFrame(loop); }
      });

      // Prevent accidental scroll bounce on iOS
      document.addEventListener('touchmove', (e)=>{ if(!e.target.closest('.palette')) e.preventDefault(); }, {passive:false});
    })();
  </script>
</body>
</html>