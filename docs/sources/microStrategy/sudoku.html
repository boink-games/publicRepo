<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sudoku - Mobile First</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#0e0f2b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href='data:application/manifest+json,{"name":"Sudoku","short_name":"Sudoku","display":"standalone","background_color":"%230e0f2b","theme_color":"%230e0f2b","start_url":"%2E%2F","scope":"%2E%2F","icons":[]}' />
  <style>
    :root{
      --bg1:#0e0f2b;
      --bg2:#4128a6;
      --bg3:#0fb7ff;
      --panel-bg: rgba(255,255,255,0.08);
      --panel-blur: blur(12px);
      --text:#f7faff;
      --muted:#cfe3ffcc;
      --accent:#61f0a6;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --grid-line:#ffffff33;
      --grid-bold:#ffffff66;
      --shadow: 0 8px 24px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.06);
      --radius: 1rem;
      --gap: 0.2rem;
      --btn-size: clamp(3rem, 9.5vw, 4.2rem);
      --safe-t: env(safe-area-inset-top);
      --safe-b: env(safe-area-inset-bottom);
      --safe-l: env(safe-area-inset-left);
      --safe-r: env(safe-area-inset-right);
      --board-size: min(92vw, 92vh);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{height:100%;}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color:var(--text);
      background:
        radial-gradient(120% 120% at 80% 10%, var(--bg3) 0%, transparent 30%),
        radial-gradient(120% 120% at 0% 100%, #e74add 0%, transparent 35%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 60%);
      min-height:100dvh;
      height:100dvh;
      overflow:hidden;
      overscroll-behavior: none;
      touch-action: none;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(1rem + var(--safe-t)) calc(1rem + var(--safe-r)) calc(1rem + var(--safe-b)) calc(1rem + var(--safe-l));
      gap:1rem;
    }

    .app{
      width:min(94vw, 70rem);
      max-width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:1rem;
      contain: layout style paint;
    }

    header.appbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0.75rem 1rem;
      background: var(--panel-bg);
      backdrop-filter: var(--panel-blur);
      border-radius: calc(var(--radius) - 0.25rem);
      box-shadow: var(--shadow);
      gap:0.5rem;
      flex: 0 0 auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:0.65rem;
      font-weight:800;
      letter-spacing:0.3px;
      text-transform:uppercase;
    }
    .brand .logo{
      width:2rem; height:2rem; border-radius:0.5rem;
      background: conic-gradient(from 0deg, #00e5ff, #7b61ff, #ff3cac, #00e5ff);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25), inset 0 0 12px rgba(255,255,255,0.25);
    }

    .status{
      display:flex; flex-wrap:wrap; gap:0.6rem 1rem; align-items:center; justify-content:flex-end;
      font-size:0.95rem; color:var(--muted);
    }
    .pill{
      background: rgba(255,255,255,0.08);
      padding:0.35rem 0.6rem;
      border-radius: 999px;
      display:flex; align-items:center; gap:0.4rem;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .dot{width:0.5rem; height:0.5rem; border-radius:50%;}
    .dot.green{background: var(--accent);}
    .dot.red{background: var(--danger);}

    main.game{
      display:grid;
      grid-template-columns: 1fr;
      gap:1rem;
      flex: 1 1 auto;
      min-height:0;
      overflow: hidden;
      align-content:start;
    }

    .board-wrap{
      display:flex; flex-direction:column; gap:0.75rem;
      align-items:center; justify-content:flex-start;
      min-height:0;
      flex: 1 1 auto;
    }

    .board{
      width: var(--board-size);
      height: var(--board-size);
      max-width: 100%;
      aspect-ratio: 1/1;
      display:grid;
      grid-template-columns: repeat(9, 1fr);
      gap: var(--gap);
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
      padding:0.4rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: var(--panel-blur);
      position:relative;
      contain: layout paint size;
      will-change: width, height;
    }

    .cell{
      position:relative;
      aspect-ratio: 1 / 1;
      display:flex; align-items:center; justify-content:center;
      font-weight: 700;
      font-size: clamp(1.1rem, 3.6vmin, 2.2rem);
      color: var(--text);
      background: rgba(255,255,255,0.05);
      border-radius: 0.35rem;
      box-shadow: inset 0 0 0 1px var(--grid-line);
      user-select: none;
      cursor: pointer;
      touch-action: manipulation;
      transition: transform 120ms ease, background 150ms ease, box-shadow 150ms ease, filter 160ms ease;
    }
    .cell:hover{ transform: translateY(-1px); }
    .cell:active{ transform: scale(0.98); }

    .cell.fixed{
      background: rgba(255,255,255,0.1);
      color: #ffffff;
      box-shadow: inset 0 0 0 1px var(--grid-bold);
      cursor: default;
    }

    .cell.selected{
      background: rgba(97,240,166,0.25);
      box-shadow: inset 0 0 0 2px var(--accent), 0 6px 18px rgba(97,240,166,0.25);
      filter: drop-shadow(0 10px 22px rgba(97,240,166,0.18));
    }

    .cell.same-number:not(.selected){ background: rgba(255,255,255,0.1); }
    .cell.related:not(.selected){ background: rgba(255,255,255,0.08); }

    .cell.conflict{
      background: rgba(255,107,107,0.25) !important;
      box-shadow: inset 0 0 0 2px var(--danger), 0 6px 18px rgba(255,107,107,0.25);
      animation: shake 200ms ease;
    }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-2%); }
      50%{ transform: translateX(2%); }
      75%{ transform: translateX(-1%); }
      100%{ transform: translateX(0); }
    }

    .board::before{
      content:"";
      position:absolute; inset:0.4rem;
      border-radius: calc(var(--radius) - 0.4rem);
      background:
        linear-gradient(currentColor, currentColor) 0% 33.333% / 100% 2px no-repeat,
        linear-gradient(currentColor, currentColor) 0% 66.666% / 100% 2px no-repeat,
        linear-gradient(currentColor, currentColor) 33.333% 0% / 2px 100% no-repeat,
        linear-gradient(currentColor, currentColor) 66.666% 0% / 2px 100% no-repeat;
      color: var(--grid-bold);
      pointer-events:none;
      opacity:0.8;
    }

    .keys{
      display:grid;
      grid-template-columns: repeat(5, minmax(var(--btn-size), 1fr));
      gap:0.6rem;
      width: 100%;
      max-width: 40rem;
      margin-inline:auto;
      padding:0.75rem;
      background: var(--panel-bg);
      backdrop-filter: var(--panel-blur);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }

    .key{
      height: var(--btn-size);
      min-width: var(--btn-size);
      border:none;
      border-radius: 0.9rem;
      color: var(--text);
      font-weight: 800;
      font-size: clamp(1.05rem, 2.8vmin, 1.35rem);
      background: linear-gradient(180deg, rgba(255,255,255,0.18), rgba(255,255,255,0.08));
      box-shadow: var(--shadow);
      cursor:pointer;
      touch-action: manipulation;
      user-select: none;
      transition: transform 120ms ease, filter 160ms ease, box-shadow 180ms ease, background 160ms ease;
    }
    .key:hover{ transform: translateY(-2px); }
    .key:active{ transform: scale(0.98); }
    .key:focus-visible{ outline: 2px solid #61f0a6; outline-offset: 2px; }
    .key.primary{ background: linear-gradient(180deg, #61f0a6, #2ecb77); color:#072314; }
    .key.warn{ background: linear-gradient(180deg, #ffd166, #f8b400); color:#4a3700; }
    .key.danger{ background: linear-gradient(180deg, #ff6b6b, #ff3b3b); color:#3b0000; }
    .key.ghost{ background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06)); }

    .controls{
      display:grid;
      grid-template-columns: repeat(4, minmax(var(--btn-size), 1fr));
      gap:0.6rem;
      width: 100%;
      max-width: 40rem;
      margin-inline:auto;
      flex: 0 0 auto;
    }

    .footer{
      display:flex; justify-content:center; align-items:center; gap:0.75rem; color:var(--muted); font-size:0.95rem;
      opacity:0.9;
      flex: 0 0 auto;
    }

    .sr-only{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    .toast{
      position:fixed; left:50%; bottom: calc(1rem + var(--safe-b));
      transform: translateX(-50%) translateY(150%);
      background: rgba(0,0,0,0.6);
      color:#fff; padding:0.6rem 0.9rem; border-radius: 0.75rem;
      backdrop-filter: blur(8px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      transition: transform 260ms ease, opacity 260ms ease;
      opacity:0; z-index: 50;
      font-size:0.95rem;
      pointer-events:none;
    }
    .toast.show{ transform: translateX(-50%) translateY(0%); opacity:1; }

    .modal{
      position:fixed; inset:0;
      display:none;
      place-items: center;
      padding: 2rem;
      background: rgba(3,6,16,0.64);
      backdrop-filter: blur(8px);
      z-index: 60;
    }
    .modal.open{ display:grid; }
    .dialog{
      width:min(90vw, 34rem);
      background: var(--panel-bg);
      backdrop-filter: var(--panel-blur);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:1.2rem;
      text-align:center;
      display:flex; flex-direction:column; gap:1rem;
      animation: pop 220ms ease;
    }
    @keyframes pop { from{ transform:scale(0.96); opacity:0; } to{ transform:scale(1); opacity:1; } }
    .dialog h2{ margin:0; font-size: clamp(1.25rem, 4.5vw, 1.65rem); }
    .dialog p{ margin:0; color:var(--muted); }

    .progress{
      width: 100%;
      max-width: 40rem;
      height: 0.6rem;
      border-radius: 999px;
      margin: 0 auto;
      background: rgba(255,255,255,0.12);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      flex: 0 0 auto;
    }
    .progress .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #7b61ff, #61f0a6, #00e5ff);
      transition: width 240ms ease;
    }

    .loading{
      position:fixed; inset:0;
      display:grid; place-items:center; z-index:100;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color:#fff;
    }
    .spinner{
      width:3rem; height:3rem; border-radius:50%;
      border: 0.35rem solid rgba(255,255,255,0.2);
      border-top-color: #61f0a6;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    @media (orientation: landscape) and (max-height: 560px){
      .app{ flex-direction:row; align-items:flex-start; }
      main.game{ grid-template-columns: 1fr 1fr; align-items:start; }
      .keys, #actions{ width: 100%; }
      .board{ width: var(--board-size); height: var(--board-size); }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading" aria-hidden="true">
    <div>
      <div class="spinner" role="status" aria-label="Loading"></div>
      <div style="text-align:center; margin-top:0.75rem; font-weight:700; letter-spacing:0.5px;">Starting Sudoku…</div>
    </div>
  </div>
  <div class="app" role="application" aria-label="Sudoku game">
    <header class="appbar" role="banner">
      <div class="brand" aria-label="Sudoku">
        <div class="logo" aria-hidden="true"></div>
        <div>Sudoku</div>
      </div>
      <div class="status" role="status" aria-live="polite">
        <div class="pill"><span class="dot green" id="net-dot"></span><span id="net-text">Online</span></div>
        <div class="pill"><span>Time</span><strong id="timer">00:00</strong></div>
        <div class="pill"><span>Mistakes</span><strong id="mistakes">0</strong></div>
        <button id="soundToggle" class="pill key ghost" style="height:auto; padding:0.35rem 0.7rem; min-width:auto;" aria-pressed="true" aria-label="Toggle sound">🔊 Sound</button>
      </div>
    </header>

    <main class="game">
      <section class="board-wrap" aria-label="Board area">
        <div id="board" class="board" role="grid" aria-label="Sudoku grid" aria-rowcount="9" aria-colcount="9"></div>
        <div class="progress" aria-hidden="true"><div class="bar" id="progressBar"></div></div>
      </section>

      <section class="controls-wrap" aria-label="Controls">
        <div class="keys" id="keypad" role="group" aria-label="Number pad">
          <button class="key" data-key="1" aria-label="Number 1">1</button>
          <button class="key" data-key="2" aria-label="Number 2">2</button>
          <button class="key" data-key="3" aria-label="Number 3">3</button>
          <button class="key" data-key="4" aria-label="Number 4">4</button>
          <button class="key" data-key="5" aria-label="Number 5">5</button>
          <button class="key" data-key="6" aria-label="Number 6">6</button>
          <button class="key" data-key="7" aria-label="Number 7">7</button>
          <button class="key" data-key="8" aria-label="Number 8">8</button>
          <button class="key" data-key="9" aria-label="Number 9">9</button>
          <button class="key warn" data-key="erase" aria-label="Erase">⌫</button>
        </div>

        <div class="controls" id="actions" role="group" aria-label="Actions">
          <button class="key ghost" id="checkBtn" aria-label="Check mistakes">Check</button>
          <button class="key primary" id="hintBtn" aria-label="Hint">Hint</button>
          <button class="key ghost" id="newBtn" aria-label="New game">New</button>
          <button class="key danger" id="solveBtn" aria-label="Solve puzzle">Solve</button>
        </div>
      </section>

      <p class="footer">Tap a cell, then tap a number. Use arrow keys and numbers on keyboard too.</p>
    </main>
  </div>

  <div class="toast" id="toast" role="alert" aria-live="polite"></div>

  <div class="modal" id="winModal" role="dialog" aria-modal="true" aria-label="You win!">
    <div class="dialog">
      <h2>Brilliant! You solved it 🎉</h2>
      <p id="winStats">Time: 00:00 • Mistakes: 0</p>
      <div class="controls" style="grid-template-columns: repeat(2, minmax(var(--btn-size), 1fr)); margin-top:0.5rem;">
        <button class="key primary" id="playAgain">Play Again</button>
        <button class="key ghost" id="closeModal">Close</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      "use strict";
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      const state = {
        board: [],
        fixed: [],
        solution: [],
        selected: {r:0,c:0},
        started: false,
        startTime: 0,
        timerId: null,
        mistakes: 0,
        hints: 3,
        muted: false,
        puzzleIndex: 0
      };

      const puzzles = [
        {name: "Classic A", grid: [
          [5,3,0,0,7,0,0,0,0],
          [6,0,0,1,9,5,0,0,0],
          [0,9,8,0,0,0,0,6,0],
          [8,0,0,0,6,0,0,0,3],
          [4,0,0,8,0,3,0,0,1],
          [7,0,0,0,2,0,0,0,6],
          [0,6,0,0,0,0,2,8,0],
          [0,0,0,4,1,9,0,0,5],
          [0,0,0,0,8,0,0,7,9]
        ]},
        {name: "Classic B", grid: [
          [0,0,0,2,6,0,7,0,1],
          [6,8,0,0,7,0,0,9,0],
          [1,9,0,0,0,4,5,0,0],
          [8,2,0,1,0,0,0,4,0],
          [0,0,4,6,0,2,9,0,0],
          [0,5,0,0,0,3,0,2,8],
          [0,0,9,3,0,0,0,7,4],
          [0,4,0,0,5,0,0,3,6],
          [7,0,3,0,1,8,0,0,0]
        ]}
      ];

      const els = {
        appbar: $('.appbar'),
        board: $('#board'),
        progress: $('#progressBar'),
        timer: $('#timer'),
        mistakes: $('#mistakes'),
        hintBtn: $('#hintBtn'),
        checkBtn: $('#checkBtn'),
        solveBtn: $('#solveBtn'),
        newBtn: $('#newBtn'),
        keypad: $('#keypad'),
        toast: $('#toast'),
        winModal: $('#winModal'),
        playAgain: $('#playAgain'),
        closeModal: $('#closeModal'),
        netDot: $('#net-dot'),
        netText: $('#net-text'),
        soundToggle: $('#soundToggle'),
        loading: $('#loading'),
        footer: $('.footer'),
        actions: $('#actions')
      };

      // Audio (WebAudio minimal)
      let audioCtx = null;
      function ensureAudio(){
        if (!audioCtx) {
          try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          } catch(e){ audioCtx = null; }
        }
        if (audioCtx && audioCtx.state === 'suspended') {
          audioCtx.resume().catch(()=>{});
        }
      }
      function beep(freq=600, dur=0.08, type='sine', vol=0.06){
        if (state.muted) return;
        ensureAudio();
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g).connect(audioCtx.destination);
        o.start();
        setTimeout(()=>{ try{ o.stop(); }catch(_){}; try{ o.disconnect(); g.disconnect(); }catch(_){}} , dur*1000);
      }
      function successChime(){
        if (state.muted) return;
        ensureAudio();
        if (!audioCtx) return;
        const notes=[523,659,784];
        let t=0;
        notes.forEach((f)=>{
          setTimeout(()=>beep(f,0.09,'triangle',0.08), t);
          t+=140;
        });
      }
      function haptic(ms=10){ if (navigator.vibrate) try{ navigator.vibrate(ms); }catch(e){} }

      function showToast(msg, ms=1400){
        const t = els.toast;
        t.textContent = msg;
        t.classList.add('show');
        clearTimeout(t._hide);
        t._hide = setTimeout(()=> t.classList.remove('show'), ms);
      }

      function deepClone(m){ return m.map(r=>r.slice()); }

      function isValid(board, r, c, num){
        for (let i=0;i<9;i++){
          if (board[r][i] === num || board[i][c] === num) return false;
        }
        const sr = Math.floor(r/3)*3, sc=Math.floor(c/3)*3;
        for (let i=0;i<3;i++) for (let j=0;j<3;j++){
          if (board[sr+i][sc+j] === num) return false;
        }
        return true;
      }

      function findEmpty(board){
        for (let r=0;r<9;r++) for (let c=0;c<9;c++) if (board[r][c]===0) return [r,c];
        return null;
      }

      function solveSudoku(board){
        const empty = findEmpty(board);
        if (!empty) return true;
        const [r,c] = empty;
        for (let n=1;n<=9;n++){
          if (isValid(board, r, c, n)){
            board[r][c]=n;
            if (solveSudoku(board)) return true;
            board[r][c]=0;
          }
        }
        return false;
      }

      function highlight(){
        const {r,c} = state.selected;
        const val = state.board[r][c];
        $$('.cell', els.board).forEach(cell=>{
          const cr = +cell.dataset.r, cc = +cell.dataset.c;
          cell.classList.toggle('selected', cr===r && cc===c);
          const sameRow = cr===r, sameCol = cc===c, sameBox = Math.floor(cr/3)===Math.floor(r/3) && Math.floor(cc/3)===Math.floor(c/3);
          cell.classList.toggle('related', (sameRow || sameCol || sameBox) && !(cr===r && cc===c));
          cell.classList.toggle('same-number', val!==0 && +cell.dataset.val === val);
        });
      }

      function draw(){
        els.board.innerHTML = '';
        els.board.setAttribute('aria-busy', 'true');
        for (let r=0;r<9;r++){
          for (let c=0;c<9;c++){
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'cell';
            btn.setAttribute('role','gridcell');
            btn.setAttribute('aria-rowindex', String(r+1));
            btn.setAttribute('aria-colindex', String(c+1));
            btn.setAttribute('aria-selected', 'false');
            btn.dataset.r = r;
            btn.dataset.c = c;
            const v = state.board[r][c];
            btn.dataset.val = v || 0;
            btn.textContent = v ? String(v) : '';
            if (state.fixed[r][c]) { btn.classList.add('fixed'); btn.setAttribute('aria-readonly','true'); }
            btn.addEventListener('pointerdown', (e)=>{
              e.preventDefault();
              selectCell(r,c);
              btn.focus({preventScroll:true});
            }, {passive:false});
            btn.addEventListener('mousedown', (e)=> e.preventDefault());
            els.board.appendChild(btn);
          }
        }
        selectCell(state.selected.r, state.selected.c, false);
        els.board.setAttribute('aria-busy', 'false');
        updateProgress();
      }

      function selectCell(r,c, beepSound=true){
        state.selected = {r,c};
        $$('.cell', els.board).forEach(el=> el.setAttribute('aria-selected', 'false'));
        const idx = r*9+c;
        const cellEl = els.board.children[idx];
        if (cellEl){ cellEl.setAttribute('aria-selected','true'); }
        highlight();
        if (beepSound) beep(400,0.05);
      }

      function placeNumber(n){
        const {r,c} = state.selected;
        if (state.fixed[r][c]) return;
        if (!state.started){ startTimer(); state.started = true; }
        if (n===0){
          state.board[r][c] = 0;
          renderCell(r,c);
          haptic(8); beep(300,0.03);
          return;
        }
        if (isValid(state.board, r, c, n)){
          state.board[r][c] = n;
          renderCell(r,c);
          haptic(10); beep(700,0.06);
          if (checkWin()){
            onWin();
          }
        }else{
          state.mistakes++;
          els.mistakes.textContent = String(state.mistakes);
          const idx=r*9+c;
          const cellEl = els.board.children[idx];
          if (cellEl){
            cellEl.classList.add('conflict');
            setTimeout(()=> cellEl.classList.remove('conflict'), 220);
          }
          haptic(30); beep(140,0.08,'square',0.08);
        }
        updateProgress();
      }

      function renderCell(r,c){
        const idx=r*9+c;
        const cellEl = els.board.children[idx];
        if (!cellEl) return;
        const v = state.board[r][c];
        cellEl.dataset.val = v || 0;
        cellEl.textContent = v ? String(v) : '';
        highlight();
      }

      function updateProgress(){
        const filled = state.board.flat().filter(v=>v!==0).length;
        const pct = Math.round((filled/81)*100);
        els.progress.style.width = pct + '%';
      }

      function checkConflicts(){
        let conflicts = 0;
        for (let r=0;r<9;r++){
          for (let c=0;c<9;c++){
            const v = state.board[r][c];
            if (v===0) continue;
            state.board[r][c] = 0;
            const ok = isValid(state.board, r, c, v);
            state.board[r][c] = v;
            const cellEl = els.board.children[r*9+c];
            if (!ok){
              conflicts++;
              cellEl.classList.add('conflict');
              setTimeout(()=> cellEl.classList.remove('conflict'), 320);
            }
          }
        }
        return conflicts;
      }

      function checkWin(){
        for (let r=0;r<9;r++){
          for (let c=0;c<9;c++){
            if (state.board[r][c]===0) return false;
          }
        }
        for (let r=0;r<9;r++){
          for (let c=0;c<9;c++){
            if (state.board[r][c] !== state.solution[r][c]) return false;
          }
        }
        return true;
      }

      function onWin(){
        stopTimer();
        successChime();
        showToast("Puzzle complete! 🎉", 1600);
        const secs = Math.floor((Date.now()-state.startTime)/1000);
        const mm = String(Math.floor(secs/60)).padStart(2,'0');
        const ss = String(secs%60).padStart(2,'0');
        $('#winStats').textContent = `Time: ${mm}:${ss} • Mistakes: ${state.mistakes}`;
        els.winModal.classList.add('open');
      }

      function startTimer(){
        state.startTime = Date.now();
        clearInterval(state.timerId);
        state.timerId = setInterval(()=>{
          const t = Date.now() - state.startTime;
          const s = Math.floor(t/1000);
          const mm = String(Math.floor(s/60)).padStart(2,'0');
          const ss = String(s%60).padStart(2,'0');
          els.timer.textContent = `${mm}:${ss}`;
        }, 1000);
      }

      function stopTimer(){
        clearInterval(state.timerId);
        state.timerId = null;
      }

      function provideHint(){
        if (state.hints <= 0){
          showToast("No hints left");
          beep(220,0.08);
          return;
        }
        const empties = [];
        for (let r=0;r<9;r++) for (let c=0;c<9;c++) if (state.board[r][c]===0) empties.push([r,c]);
        if (empties.length===0) { showToast("Nothing to hint"); return; }
        const [r,c] = empties[Math.floor(Math.random()*empties.length)];
        state.board[r][c] = state.solution[r][c];
        state.fixed[r][c] = false;
        renderCell(r,c);
        selectCell(r,c,false);
        state.hints--;
        showToast(`Hint used (${3 - state.hints}/3)`);
        beep(880,0.07,'triangle',0.07);
        haptic(12);
        updateProgress();
        if (checkWin()) onWin();
      }

      function newGame(idx = (state.puzzleIndex+1) % puzzles.length){
        try{
          state.puzzleIndex = idx;
          const puzzle = puzzles[idx].grid;
          state.board = deepClone(puzzle);
          state.fixed = puzzle.map(row => row.map(v => v !== 0));
          state.selected = {r:0,c:0};
          state.mistakes = 0;
          state.hints = 3;
          els.mistakes.textContent = '0';
          els.timer.textContent = '00:00';
          state.started = false;
          stopTimer();
          const sol = deepClone(puzzle);
          if (!solveSudoku(sol)) {
            console.error("No solution found for puzzle index " + idx);
          }
          state.solution = sol;
          draw();
          showToast(`Loaded ${puzzles[idx].name}`);
        }catch(e){
          console.error(e);
          showToast("Error starting game");
        }
      }

      function solveAll(){
        try{
          state.board = deepClone(state.solution);
          draw();
          onWin();
        }catch(e){
          showToast("Unable to solve");
        }
      }

      // Input handlers
      function handleKeypad(e){
        if (!(e.target instanceof HTMLElement)) return;
        const keyEl = e.target.closest('.key');
        if (!keyEl) return;
        e.preventDefault();
        const k = keyEl.dataset.key;
        if (!k) return;
        if (k === 'erase') { placeNumber(0); return; }
        const n = parseInt(k, 10);
        if (n>=1 && n<=9){ placeNumber(n); }
      }

      function handleKeyboard(e){
        const {r,c} = state.selected;
        if (e.key === 'ArrowUp') { selectCell(Math.max(0,r-1), c); e.preventDefault(); }
        else if (e.key === 'ArrowDown') { selectCell(Math.min(8,r+1), c); e.preventDefault(); }
        else if (e.key === 'ArrowLeft') { selectCell(r, Math.max(0,c-1)); e.preventDefault(); }
        else if (e.key === 'ArrowRight') { selectCell(r, Math.min(8,c+1)); e.preventDefault(); }
        else if (/^[1-9]$/.test(e.key)){ placeNumber(+e.key); e.preventDefault(); }
        else if (e.key==='Backspace' || e.key==='Delete' || e.key==='0'){ placeNumber(0); e.preventDefault(); }
        else if (e.key.toLowerCase()==='h'){ provideHint(); }
        else if (e.key.toLowerCase()==='c'){ const n=checkConflicts(); showToast(n?`${n} conflict(s)`: 'No conflicts'); }
      }

      // Dynamic layout sizing to prevent vertical scroll and fit board nicely
      let resizeRaf = 0;
      function computeBoardSize(){
        const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        const styles = getComputedStyle(document.body);
        const pt = parseFloat(styles.paddingTop) || 0;
        const pb = parseFloat(styles.paddingBottom) || 0;

        const headerH = els.appbar ? els.appbar.offsetHeight : 0;
        const footerH = els.footer ? els.footer.offsetHeight : 0;
        const keysH = els.keypad ? els.keypad.offsetHeight : 0;
        const actionsH = els.actions ? els.actions.offsetHeight : 0;

        const isLandscape = vw > vh;
        const verticalStackHeights = isLandscape ? 0 : (keysH + actionsH);

        const gutters = 28; // gaps/margins allowance
        const availableH = Math.max(0, vh - pt - pb - headerH - footerH - verticalStackHeights - gutters);
        let size = Math.min(availableH, vw * 0.94);
        if (!isFinite(size) || size <= 0) size = Math.min(vw, vh) * 0.9;
        size = Math.max(size, Math.min(vw, vh) * 0.6); // keep playable

        document.documentElement.style.setProperty('--board-size', size + 'px');
      }
      function queueResize(){
        cancelAnimationFrame(resizeRaf);
        resizeRaf = requestAnimationFrame(computeBoardSize);
      }

      function bindEvents(){
        els.keypad.addEventListener('pointerdown', handleKeypad, {passive:false});
        els.keypad.addEventListener('mousedown', e=>e.preventDefault());
        els.hintBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); provideHint(); }, {passive:false});
        els.checkBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); const n = checkConflicts(); showToast(n?`${n} conflict(s) found`:'Looks good!'); beep(n?260:980,0.07); }, {passive:false});
        els.solveBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); solveAll(); }, {passive:false});
        els.newBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); newGame(); }, {passive:false});
        els.playAgain.addEventListener('pointerdown', (e)=>{ e.preventDefault(); els.winModal.classList.remove('open'); newGame(); }, {passive:false});
        els.closeModal.addEventListener('pointerdown', (e)=>{ e.preventDefault(); els.winModal.classList.remove('open'); }, {passive:false});
        document.addEventListener('keydown', handleKeyboard);

        // Close win modal by tapping backdrop
        els.winModal.addEventListener('pointerdown', (e)=>{ if (e.target === els.winModal){ els.winModal.classList.remove('open'); } });

        // Sound toggle
        els.soundToggle.addEventListener('pointerdown', (e)=>{
          e.preventDefault();
          state.muted = !state.muted;
          els.soundToggle.textContent = state.muted ? '🔇 Sound Off' : '🔊 Sound';
          els.soundToggle.setAttribute('aria-pressed', String(!state.muted));
          localStorage.setItem('sudoku_muted', state.muted ? '1' : '0');
          if (!state.muted) beep(760,0.07);
        }, {passive:false});

        // Online/offline
        const updateNet = () => {
          const online = navigator.onLine;
          els.netDot.classList.toggle('green', online);
          els.netDot.classList.toggle('red', !online);
          els.netText.textContent = online ? 'Online' : 'Offline';
        };
        window.addEventListener('online', updateNet);
        window.addEventListener('offline', updateNet);
        updateNet();

        // Prevent pull-to-refresh on mobile
        let lastY = 0;
        window.addEventListener('touchstart', (e)=>{ lastY = e.touches[0].clientY; }, {passive:true});
        window.addEventListener('touchmove', (e)=>{
          const y = e.touches[0].clientY;
          if (window.scrollY === 0 && y > lastY) e.preventDefault();
        }, {passive:false});

        // Resize handling
        window.addEventListener('resize', queueResize, {passive:true});
        window.addEventListener('orientationchange', queueResize);

        // Error boundaries
        window.addEventListener('error', (ev)=>{
          console.error(ev.message);
          showToast('An error occurred');
        });
        window.addEventListener('unhandledrejection', (ev)=>{
          console.error(ev.reason);
          showToast('Something went wrong');
        });
      }

      function init(){
        // Restore settings
        state.muted = localStorage.getItem('sudoku_muted') === '1';
        els.soundToggle.textContent = state.muted ? '🔇 Sound Off' : '🔊 Sound';
        els.soundToggle.setAttribute('aria-pressed', String(!state.muted));

        bindEvents();
        // Start first puzzle and fade out loading
        newGame(0);
        queueResize();
        setTimeout(()=>{
          els.loading.style.transition = 'opacity 280ms ease';
          els.loading.style.opacity = '0';
          setTimeout(()=>{ els.loading.remove(); }, 320);
        }, 350);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, {once:true});
      } else init();
    })();
  </script>
</body>
</html>