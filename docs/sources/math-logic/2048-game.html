<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>2048 — Mobile First</title>
  <meta name="theme-color" content="#0d0f25">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href='data:application/manifest+json,{"name":"2048","short_name":"2048","start_url":"./","display":"standalone","theme_color":"#0d0f25","background_color":"#0d0f25","icons":[]}'/>
  <style>
    :root{
      --bg-a:#0d0f25;
      --bg-b:#1b1754;
      --bg-c:#3a0ca3;
      --bg-d:#7209b7;
      --ui:#ffffff;
      --muted:#c7c7d1;
      --accent:#ffb703;
      --accent-2:#00f5d4;
      --shadow:0 0.6rem 2rem rgba(0,0,0,.35);
      --radius:1rem;
      --gap:clamp(.6rem,1.6vw,1rem);
      --board-max:min(92vw, 90vh);
      --tile-font:clamp(1rem, 5.5vw, 3rem);
      --touch-target:3rem; /* >= 44px */
      --tile-radius:.8rem;
      --tile-shadow:0 .3rem .8rem rgba(0,0,0,.25);
      --speed:160ms;
    }
    *{box-sizing:border-box; max-width: 100%;}
    html,body{
      height:100vh;
      margin:0;
      overscroll-behavior:none;
      overflow: hidden;
      position: relative;
      background: radial-gradient(120% 120% at 10% 10%, var(--bg-c), transparent 40%),
                  radial-gradient(120% 120% at 90% 15%, var(--bg-d), transparent 40%),
                  radial-gradient(120% 130% at 50% 100%, var(--bg-b), var(--bg-a));
      color:var(--ui);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding: max(env(safe-area-inset-top), 1rem) max(env(safe-area-inset-right), 1rem) max(env(safe-area-inset-bottom), 1rem) max(env(safe-area-inset-left), 1rem);
      gap:1rem;
      /* border removed */
    }
    main{
      width:100%;
      height: 100%;
      overflow-y: auto;
      max-width: var(--board-max);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:1rem;
    }
    header{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.8rem;
    }
    .title{display:flex;align-items:baseline;gap:.6rem;}
    .title h1{margin:0;font-size: clamp(1.4rem, 6vw, 2rem);letter-spacing:.04em;text-shadow: 0 .2rem .6rem rgba(0,0,0,.3);}
    .badges{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;}
    .chip{background: linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.18);padding:.35rem .6rem;border-radius:999px;font-size:.8rem;color:var(--muted);box-shadow: var(--shadow);backdrop-filter: blur(6px);}
    .panel{width:100%;display:flex;align-items:center;justify-content:space-between;gap:.8rem;flex-wrap:wrap;}
    .scores{display:flex;gap:.6rem;align-items:stretch;flex-wrap:wrap;}
    .box{flex: 1;padding:.6rem .8rem;border-radius: var(--radius);background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.18);box-shadow: var(--shadow);text-align:center;}
    .box small{display:block;color:var(--muted);font-size:.8rem;letter-spacing:.06em}
    .box strong{display:block;font-size:clamp(1rem,4.5vw,1.4rem);margin-top:.1rem}
    .actions{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;}
    button{appearance:none;border:0;border-radius: .9rem;padding:.7rem .9rem;min-height:var(--touch-target);min-width:var(--touch-target);background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));border:1px solid rgba(255,255,255,.22);color:var(--ui);font-weight:600;box-shadow: var(--shadow);transition: transform .12s ease, filter .2s ease, background .2s ease, box-shadow .2s ease;cursor:pointer;touch-action: manipulation;}
    button.icon{display:inline-flex;align-items:center;justify-content:center;padding:.6rem;aspect-ratio:1/1;font-size:1.1rem;}
    button.primary{background: linear-gradient(180deg, var(--accent), #ff7a00); color:#1b0b00;}
    button[aria-pressed="true"]{filter:saturate(1.3) brightness(1.1)}
    button:active{transform: scale(.97)}
    button:focus-visible{outline:3px solid var(--accent-2); outline-offset:2px}
    #board-wrap{width: 100%;display:flex;justify-content:center;}
    #board{width: var(--board-max);max-width: 100%;aspect-ratio: 1/1;background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.18);border-radius: var(--radius);padding: var(--gap);box-shadow: var(--shadow);position: relative;overflow: hidden;touch-action: none;user-select:none;}
    .grid{position:absolute;inset: var(--gap);display:grid;grid-template-columns: repeat(4, 1fr);grid-template-rows: repeat(4, 1fr);gap: var(--gap);pointer-events:none;}
    .cell{background: rgba(255,255,255,.08);border-radius: var(--tile-radius);box-shadow: inset 0 .2rem .6rem rgba(0,0,0,.25);}
    .tiles{position:absolute;inset: var(--gap);display:grid;grid-template-columns: repeat(4, 1fr);grid-template-rows: repeat(4, 1fr);gap: var(--gap);}
    .tile{display:flex;align-items:center;justify-content:center;border-radius: var(--tile-radius);font-weight:800;font-variant-numeric: tabular-nums;text-shadow: 0 .15rem .35rem rgba(0,0,0,.3);box-shadow: var(--tile-shadow);font-size: var(--tile-font);line-height:1;transition: transform var(--speed) ease, background-color var(--speed) ease, color var(--speed) ease, filter var(--speed) ease;will-change: transform;aspect-ratio: 1/1;user-select:none;}
    .tile.spawn{animation: pop .22s ease-out}
    @keyframes pop{0%{transform: scale(.6); filter:brightness(1.2)}70%{transform: scale(1.08)}100%{transform: scale(1)}}
    .tile.bump{animation: bump .18s ease-out}
    @keyframes bump{0%{transform: scale(1)}50%{transform: scale(1.06)}100%{transform: scale(1)}}
    /* Tile colors */
    .tile-0{background: rgba(255,255,255,.04); color: transparent}
    .tile-2{background:#eee4da; color:#776e65}
    .tile-4{background:#ede0c8; color:#776e65}
    .tile-8{background:#f2b179; color:#f9f6f2}
    .tile-16{background:#f59563;color:#f9f6f2}
    .tile-32{background:#f67c5f;color:#f9f6f2}
    .tile-64{background:#f65e3b;color:#f9f6f2}
    .tile-128{background:#edcf72;color:#f9f6f2}
    .tile-256{background:#edcc61;color:#f9f6f2}
    .tile-512{background:#edc850;color:#f9f6f2}
    .tile-1024{background:#edc53f;color:#f9f6f2}
    .tile-2048{background:linear-gradient(180deg,#edc22e,#ffd400); color:#1b1400}
    .tile-super{background:linear-gradient(180deg,#00f5d4,#00bbf9); color:#001b1f}
    /* Controls (D-Pad) */
    .controls{display:grid;grid-template-columns: repeat(3, minmax(var(--touch-target), 1fr));grid-template-rows: repeat(3, minmax(var(--touch-target), 1fr));gap:.5rem; margin-top:.2rem;touch-action: manipulation;}
    .controls .spacer{visibility:hidden}
    .toast, .overlay{position:fixed;inset:auto auto max(env(safe-area-inset-bottom), 1rem) 50%;transform: translateX(-50%); z-index:10;background: rgba(0,0,0,.6); color:#fff; padding:.6rem .8rem; border-radius:.8rem; font-size:.9rem;display:none; box-shadow: var(--shadow);}
    .toast.show{display:block; animation: fade .4s ease}
    @keyframes fade{from{opacity:0; transform:translateX(-50%) translateY(.5rem)} to{opacity:1; transform:translateX(-50%) translateY(0)}}
    .status{position:fixed; top: max(env(safe-area-inset-top), .6rem); right:max(env(safe-area-inset-right), .6rem);z-index:10;}
    .overlay{inset:0; background: rgba(9,10,32,.7);display:none; align-items:center; justify-content:center; text-align:center; padding:2rem;backdrop-filter: blur(4px);}
    .overlay.show{display:flex}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.18);border-radius: var(--radius);padding:1rem; max-width:28rem; box-shadow: var(--shadow);}
    .card h2{margin:.2rem 0 .6rem 0}
    .card p{margin:.2rem 0; color: var(--muted)}
    .card .row{display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin-top:.8rem}
    .loader{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:100;background: radial-gradient(120% 120% at 10% 10%, var(--bg-c), transparent 40%),radial-gradient(120% 120% at 90% 15%, var(--bg-d), transparent 40%),radial-gradient(120% 130% at 50% 100%, var(--bg-b), var(--bg-a));transition: opacity .3s ease, visibility .3s ease;}
    .loader.hidden{opacity:0; visibility:hidden}
    .spinner{width:3rem; aspect-ratio:1; border-radius:50%;border:.3rem solid rgba(255,255,255,.25);border-top-color: var(--accent);animation: spin 1s linear infinite;}
    @keyframes spin{to{transform: rotate(360deg)}}
  </style>
</head>
<body>
  <div class="loader" id="loader" aria-hidden="true"><div class="spinner" role="progressbar" aria-label="Loading"></div></div>
  <main id="app" role="application" aria-label="2048 Game">
    <header>
      <div class="title">
        <h1>2048</h1>
        <span class="chip">Mobile First</span>
      </div>
      <div class="badges">
        <span id="net" class="chip" aria-live="polite">Online</span>
      </div>
    </header>

    <section class="panel" aria-label="Score and actions">
      <div class="scores" role="group" aria-label="Scoreboard">
        <div class="box" aria-live="polite" aria-atomic="true">
          <small>Score</small>
          <strong id="score">0</strong>
        </div>
        <div class="box" aria-live="polite" aria-atomic="true">
          <small>Best</small>
          <strong id="best">0</strong>
        </div>
      </div>
      <div class="actions" role="toolbar" aria-label="Game actions">
        <button id="soundBtn" class="icon" aria-label="Toggle sound" aria-pressed="false" title="Sound off">🔈</button>
        <button id="helpBtn" class="icon" aria-label="How to play" title="How to play">❓</button>
        <button id="restartBtn" class="primary" aria-label="Restart game">Restart</button>
      </div>
    </section>

    <section id="board-wrap" aria-label="Game board wrapper">
      <div id="board" role="grid" aria-label="4 by 4 game board" aria-live="off">
        <div class="grid" aria-hidden="true" id="grid"></div>
        <div class="tiles" id="tiles"></div>
      </div>
    </section>

    <section class="controls" role="group" aria-label="Directional controls">
      <div class="spacer"></div>
      <button id="upBtn" class="icon" aria-label="Move up">⬆️</button>
      <div class="spacer"></div>
      <button id="leftBtn" class="icon" aria-label="Move left">⬅️</button>
      <button id="downBtn" class="icon" aria-label="Move down">⬇️</button>
      <button id="rightBtn" class="icon" aria-label="Move right">➡️</button>
      <div class="spacer"></div>
      <div class="spacer"></div>
      <div class="spacer"></div>
    </section>
  </main>

  <div id="announce" class="toast" role="status" aria-live="polite"></div>

  <div id="overlay" class="overlay" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="card">
      <h2 id="overlayTitle">Game Over</h2>
      <p id="overlayMsg">No more moves available.</p>
      <div class="row">
        <button id="continueBtn" class="icon" aria-label="Continue playing">▶️</button>
        <button id="againBtn" class="primary" aria-label="Play again">Play again</button>
      </div>
    </div>
  </div>
  <script>
    (function(){
      const SIZE = 4;
      let grid = createEmpty();
      let score = 0;
      let best = parseInt(localStorage.getItem('best2048') || '0', 10);
      let allowContinue = false;
      let won = false;

      const loader = document.getElementById('loader');
      const tilesEl = document.getElementById('tiles');
      const gridEl = document.getElementById('grid');
      const scoreEl = document.getElementById('score');
      const bestEl = document.getElementById('best');
      const overlay = document.getElementById('overlay');
      const overlayTitle = document.getElementById('overlayTitle');
      const overlayMsg = document.getElementById('overlayMsg');
      const announce = document.getElementById('announce');
      const soundBtn = document.getElementById('soundBtn');

      // --- Simple sound system (Web Audio) ---
      let audioCtx = null;
      let soundOn = soundBtn?.getAttribute('aria-pressed') === 'true';
      function ensureAudio() {
        if (!audioCtx) {
          try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch (_) { audioCtx = null; }
        }
        return !!audioCtx;
      }
      function beep(freq = 440, duration = 0.08, type = 'sine', vol = 0.04) {
        if (!soundOn) return;
        if (!ensureAudio()) return;
        const now = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(vol, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
        o.connect(g).connect(audioCtx.destination);
        o.start(now);
        o.stop(now + duration + 0.02);
      }
      function playSequence(freqs = [440, 660, 880], step = 0.09) {
        if (!soundOn) return;
        if (!ensureAudio()) return;
        freqs.forEach((f, i) => setTimeout(() => beep(f, 0.08, 'sine', 0.05), i * step * 1000));
      }
      function playSound(kind, value) {
        switch (kind) {
          case 'spawn':
            beep(value === 4 ? 540 : 520, 0.06, 'triangle', 0.035);
            break;
          case 'merge': {
            // Map tile value to pitch (higher value, higher pitch)
            const p = Math.log2(Math.max(2, value));
            const base = 320;
            beep(base + p * 60, 0.09, 'square', 0.045);
            break;
          }
          case 'bump':
            beep(180, 0.06, 'sine', 0.03);
            break;
          case 'win':
            playSequence([520, 660, 820, 980], 0.1);
            break;
          case 'lose':
            playSequence([320, 260, 200], 0.12);
            break;
        }
      }

      // Build static grid cells
      function buildGridCells(){
        gridEl.innerHTML = '';
        for(let i=0;i<SIZE*SIZE;i++){
          const div = document.createElement('div');
          div.className = 'cell';
          gridEl.appendChild(div);
        }
      }

      function createEmpty(){
        return Array.from({length: SIZE}, () => Array(SIZE).fill(0));
      }

      function getEmptyCells(){
        const cells = [];
        for(let r=0;r<SIZE;r++){
          for(let c=0;c<SIZE;c++){
            if(grid[r][c] === 0) cells.push({r,c});
          }
        }
        return cells;
      }

      function spawn(count=1){
        const empties = getEmptyCells();
        for(let i=0;i<count && empties.length>0;i++){
          const idx = Math.floor(Math.random()*empties.length);
          const {r,c} = empties.splice(idx,1)[0];
          grid[r][c] = Math.random() < 0.9 ? 2 : 4;
          playSound('spawn', grid[r][c]);
          render(true); // apply spawn animation for new tiles
        }
      }

      function render(spawnAnim=false){
        tilesEl.innerHTML = '';
        for(let r=0;r<SIZE;r++){
          for(let c=0;c<SIZE;c++){
            const v = grid[r][c];
            if(v===0) continue;
            const t = document.createElement('div');
            t.className = `tile tile-${v>2048?'super':v}${spawnAnim?' spawn':''}`;
            t.style.gridRowStart = r+1;
            t.style.gridColumnStart = c+1;
            t.textContent = v;
            tilesEl.appendChild(t);
          }
        }
        scoreEl.textContent = String(score);
        bestEl.textContent = String(best);
      }

      function slide(row){
        const original = row.slice();
        let arr = row.filter(v => v!==0);
        let merged = Array(arr.length).fill(false);
        for(let i=0;i<arr.length-1;i++){
          if(arr[i]!==0 && arr[i]===arr[i+1] && !merged[i] && !merged[i+1]){
            arr[i] = arr[i]*2; arr.splice(i+1,1); merged[i]=true; score += arr[i];
            playSound('merge', arr[i]);
            if(arr[i]===2048 && !won){ showWin(); won=true; }
          }
        }
        while(arr.length < SIZE) arr.push(0);
        const changed = arr.some((v,i)=>v!==original[i]);
        return {row: arr, changed};
      }

      function rotateRight(m){
        const res = createEmpty();
        for(let r=0;r<SIZE;r++) for(let c=0;c<SIZE;c++) res[c][SIZE-1-r]=m[r][c];
        return res;
      }
      function rotateLeft(m){ return rotateRight(rotateRight(rotateRight(m))); }
      function flipH(m){ return m.map(row=>row.slice().reverse()); }

      function move(dir){
        // dir: 'left','right','up','down'
        let changedAny = false;
        let g = grid.map(r=>r.slice());
        if(dir==='right') g = flipH(g);
        if(dir==='up') g = rotateLeft(g);
        if(dir==='down') g = rotateRight(g);

        for(let r=0;r<SIZE;r++){
          const {row,changed} = slide(g[r]);
          g[r]=row; if(changed) changedAny=true;
        }

        if(dir==='right') g = flipH(g);
        if(dir==='up') g = rotateRight(g);
        if(dir==='down') g = rotateLeft(g);

        if(changedAny){
          grid = g;
          if(score>best){ best=score; localStorage.setItem('best2048', String(best)); }
          spawn(1);
          render();
          if(!canMove()) showGameOver();
        } else {
          bumpTiles();
          playSound('bump');
        }
      }

      function bumpTiles(){
        // Visual nudge when move not possible
        tilesEl.querySelectorAll('.tile').forEach(el=>{
          el.classList.remove('bump');
          void el.offsetWidth; // reflow
          el.classList.add('bump');
        });
      }

      function canMove(){
        if(getEmptyCells().length>0) return true;
        // Check merges
        for(let r=0;r<SIZE;r++){
          for(let c=0;c<SIZE;c++){
            const v=grid[r][c];
            if(r+1<SIZE && grid[r+1][c]===v) return true;
            if(c+1<SIZE && grid[r][c+1]===v) return true;
          }
        }
        return false;
      }

      function showWin(){
        overlayTitle.textContent = 'You win!';
        overlayMsg.textContent = 'Keep playing to increase your score.';
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
        allowContinue = true;
        playSound('win');
      }

      function showGameOver(){
        overlayTitle.textContent = 'Game Over';
        overlayMsg.textContent = 'No more moves available.';
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
        playSound('lose');
      }

      function hideOverlay(){
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden','true');
      }

      function newGame(){
        grid = createEmpty();
        score = 0; won=false; allowContinue=false;
        spawn(2);
        render();
      }

      // Controls
      document.getElementById('restartBtn').addEventListener('click', ()=>{ hideOverlay(); newGame(); announceMsg('New game'); });
      document.getElementById('againBtn').addEventListener('click', ()=>{ hideOverlay(); newGame(); });
      document.getElementById('continueBtn').addEventListener('click', ()=>{ hideOverlay(); });
      document.getElementById('helpBtn').addEventListener('click', ()=>{
        overlayTitle.textContent = 'How to play';
        overlayMsg.textContent = 'Swipe or use arrow keys to move tiles. Merge tiles with the same number to reach 2048!';
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden','false');
      });
      soundBtn.addEventListener('click', (e)=>{
        const pressed = e.currentTarget.getAttribute('aria-pressed')==='true';
        const next = !pressed;
        e.currentTarget.setAttribute('aria-pressed', String(next));
        e.currentTarget.textContent = next ? '🔊' : '🔈';
        e.currentTarget.title = next ? 'Sound on' : 'Sound off';
        soundOn = next;
        if (soundOn) { ensureAudio(); beep(520, 0.08, 'sine', 0.05); }
      });

      // Keyboard
      window.addEventListener('keydown', (e)=>{
        if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
          e.preventDefault();
          if(overlay.classList.contains('show') && !allowContinue) return;
          switch(e.key){
            case 'ArrowLeft': move('left'); break;
            case 'ArrowRight': move('right'); break;
            case 'ArrowUp': move('up'); break;
            case 'ArrowDown': move('down'); break;
          }
        }
      });

      // D-pad buttons
      [['leftBtn','left'],['rightBtn','right'],['upBtn','up'],['downBtn','down']].forEach(([id,dir])=>{
        const btn = document.getElementById(id); if(!btn) return;
        btn.addEventListener('click', ()=> move(dir));
      });

      // Swipe controls
      (function registerSwipe(){
        const board = document.getElementById('board');
        let sx=0, sy=0; let tracking=false;
        board.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; tracking=true; }, {passive:true});
        board.addEventListener('touchend', (e)=>{
          if(!tracking) return; tracking=false;
          const t=e.changedTouches[0]; const dx=t.clientX - sx; const dy=t.clientY - sy;
          if(Math.abs(dx)<30 && Math.abs(dy)<30) return;
          if(Math.abs(dx)>Math.abs(dy)) move(dx>0?'right':'left'); else move(dy>0?'down':'up');
        }, {passive:true});
      })();

      // Online status
      const netChip = document.getElementById('net');
      function updateNet(){ netChip.textContent = navigator.onLine? 'Online' : 'Offline'; }
      window.addEventListener('online', updateNet);
      window.addEventListener('offline', updateNet);
      updateNet();

      function announceMsg(msg){
        announce.textContent = msg; announce.classList.add('show');
        setTimeout(()=> announce.classList.remove('show'), 1200);
      }

      // Start
      buildGridCells();
      newGame();
      // Hide loader
      requestAnimationFrame(()=> loader.classList.add('hidden'));
    })();
  </script>
</body>
</html>
